<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title>
jq ã¯ã˜ã‚ã¾ã—ãŸ | å†·ãŸãæ²¢ã®å²©é™°ã®
</title>

        
<meta property="og:image" content="https:&#x2F;&#x2F;kenoss.github.io&#x2F;ogp.jpg" />
<meta property="og:title" content="jq ã¯ã˜ã‚ã¾ã—ãŸ" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https:&#x2F;&#x2F;kenoss.github.io&#x2F;blog&#x2F;2024-06-14-jq-hands-on&#x2F;" />

<meta property="og:site_name" content="å†·ãŸãæ²¢ã®å²©é™°ã®" />

<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@keno_ss" />


        



        <link rel="stylesheet" href="https://kenoss.github.io/theme.css">
    </head>
    <body>
        <div class="content">
            <header>
                <div class="header-left">
                    <a href="https:&#x2F;&#x2F;kenoss.github.io" class="header-logo">å†·ãŸãæ²¢ã®å²©é™°ã®</a>
                </div>
                <div class="header-right">
                </div>
            </header>
            <main>
                
<article itemscope itemtype="http://schema.org/BlogPosting">
    <div class="headline" itemprop="headline">
        <h1 class="post-title">jq ã¯ã˜ã‚ã¾ã—ãŸ</h2>
        <div class="border"></div>
        <div>
            <time datetime="2024-06-14" class="post-date" itemprop="datePublished">
                2024-06-14
            </time>
            
                |
                
                    <span class="post-tag">ğŸ¦€ tech</span>
                
                    <span class="post-tag">ğŸ¦€ jq</span>
                
                        
        </div>
    </div>
    <div itemprop="articleBody">
        <h2 id="tl-dr">TL;DR</h2>
<p>jq ã‚’çœŸé¢ç›®ã«ä½¿ã£ãŸã“ã¨ãŒãªã‹ã£ãŸã‘ã©ã¯ã˜ã‚ã¦ã¿ãŸã®ã§å‚™å¿˜éŒ².</p>
<p>åˆå¿ƒè€…ãŒæ›¸ã„ã¦ã„ã‚‹ã®ã§ã‚‚ã£ã¨è‰¯ã„æ›¸ãæ–¹ãŒã‚ã£ãŸã‚‰æ•™ãˆã¦ã»ã—ã„.</p>
<h2 id="wen-ti">å•é¡Œ</h2>
<p>ãƒªãƒã‚¸ãƒˆãƒªã«ãƒ†ã‚¹ãƒˆã‚’ç®¡ç†ã—ã¦ã„ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒã‚ã‚‹. ãƒ†ã‚¹ãƒˆãƒ©ãƒ³ãƒŠãƒ¼ã¯ãã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªé…ä¸‹ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ <code>test_result.json</code> ã«çµæœã®ã‚µãƒãƒªã‚’æ›¸ã.
è©³ç´°ãªã‚¨ãƒ©ãƒ¼ãªã©ã¯åˆ¥ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ã.</p>
<p>ã“ã®è¨˜äº‹ã§ã¯ä»¥ä¸‹ã®ä¾‹ã‚’ç”¨ã„ã‚‹. ã¡ã‚‡ã£ã¨é•·ã„ã®ã§å…¨ä½“ã¯ <a href="https://kenoss.github.io/blog/2024-06-14-jq-hands-on/test_result.json">ã“ã¡ã‚‰</a>:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>$ cat test_result.json | jq -C .
</span><span>{
</span><span>  &quot;version&quot;: 3,
</span><span>  ...
</span><span>  &quot;tests&quot;: {
</span><span>    &quot;virtual&quot;: {
</span><span>      &quot;hoge&quot;: {
</span><span>        &quot;http&quot;: {
</span><span>          &quot;tests&quot;: {
</span><span>            &quot;protocol&quot;: {
</span><span>              &quot;domain0&quot;: {
</span><span>                &quot;test0.js&quot;: {
</span><span>                  &quot;expected&quot;: &quot;PASS&quot;,
</span><span>                  &quot;actual&quot;: &quot;SKIP&quot;,
</span><span>                  &quot;other&quot;: null
</span><span>                },
</span><span>                &quot;test1.js&quot;: {
</span><span>                  &quot;expected&quot;: &quot;CRASH&quot;,
</span><span>                  &quot;actual&quot;: &quot;CRASH&quot;,
</span><span>                  &quot;other&quot;: null,
</span><span>                  &quot;crash_site&quot;: &quot;hoge.cc(42)&quot;,
</span><span>                  &quot;artifacts&quot;: {
</span><span>                    &quot;command&quot;: [
</span><span>                      &quot;test-output-dir/virtual/hoge/tests/protocol/domain0/test1-command.txt&quot;
</span><span>                    ],
</span><span>                    &quot;stderr&quot;: [
</span><span>                      &quot;test-output-dir/virtual/hoge/tests/protocol/domain0/test1-stderr.txt&quot;
</span><span>                    ],
</span><span>                    &quot;carsh_log&quot;: [
</span><span>                      &quot;test-output-dir/virtual/hoge/tests/protocol/domain0/test1-crash-log.txt&quot;
</span><span>                    ]
</span><span>                  }
</span><span>                }
</span><span>              },
</span><span>              &quot;domain1&quot;: {
</span><span>                &quot;test0.js&quot;: {
</span><span>                  &quot;expected&quot;: &quot;PASS&quot;,
</span><span>                  &quot;actual&quot;: &quot;FAIL&quot;,
</span><span>...
</span></code></pre>
<p>ã“ã®ä¾‹ã§ã¯</p>
<ul>
<li><code>virtual/hoge/http/tests/protocol/domain0/test0.js</code></li>
<li><code>virtual/hoge/http/tests/protocol/domain0/test1.js</code></li>
<li><code>virtual/hoge/http/tests/protocol/domain1/test0.js</code></li>
<li><code>virtual/hoge/http/tests/other/test0.js</code></li>
</ul>
<p>ã¨ã„ã†4ã¤ã®ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Š, ã¿ã£ã¤ã‚ã®ã‚‚ã®ãŒ PASS ã™ã¹ããªã®ã« FAIL ã—ã¦ã„ã‚‹. ä»–ã¯ SKIP æŒ‡å®šã‚’ã•ã‚Œã¦ã„ã‚‹ã‹ (<code>"expected": "SKIP"</code>) , æœŸå¾…ã—ãŸçµæœã«ãªã£ã¦ã„ã‚‹ (<code>"expected"</code> ã¨ <code>"actual"</code> ãŒä¸€è‡´ã—ã¦ã„ã‚‹).
(ä¾‹ãªã®ã§å°‘ãªã„ãŒ, å®Ÿéš›ã«ã¯ã‚‚ã£ã¨å¤šã„.)</p>
<p>ã•ã¦, ã“ã“ã‹ã‚‰äººé–“ãŒèª­ã¿ã‚„ã™ã„ã‚µãƒãƒªã‚’ç”Ÿæˆã—ãŸã„. ã“ã®è¨˜äº‹ã§ã¯ä»¥ä¸‹ã®å‡ºåŠ›ã‚’ç›®æŒ‡ã™:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>$ cat test_result.json | &lt;somecommand&gt;
</span><span>{
</span><span>  &quot;virtual/hoge/http/tests/protocol/domain1/test0.js&quot;: {
</span><span>    &quot;expected&quot;: &quot;PASS&quot;,
</span><span>    &quot;actual&quot;: &quot;FAIL&quot;
</span><span>  }
</span><span>}
</span></code></pre>
<p>ã“ã†ã„ã†ã®ã¯ jq ã§ã§ãã‚‹ã¯ãšã§ã‚ã‚‹. (ãŸã¶ã‚“)</p>
<h2 id="xin-gou-e">å¿ƒæ§‹ãˆ</h2>
<p>æ¤œç´¢ã™ã‚‹ã¨ãã«ãŠã™ã™ã‚ãªã®ã¯ã€Œçµ¶å¯¾ã«ã§ãã‚‹ã¯ãš. æƒ…å ±ã¯ã©ã“ã‹ã«æ›¸ã‹ã‚Œã¦ã„ã‚‹ã¯ãšã§ã‚ã‚Šè¦‹ä»˜ã‘ã‚‰ã‚Œã¦ã„ãªã„ã®ã¯è‡ªåˆ†ãŒè¦‹ä»˜ã‘ã‚‰ã‚Œã¦ã„ãªã„ã‹ã‚‰ã§ã‚ã‚‹ã€ã¨ã„ã†è‡ªå·±å‚¬çœ ã‚’ã‹ã‘ã‚‹ã“ã¨ã§ã‚ã‚‹.
ã“ã‚Œã§æ¤œç´¢åŠ›ãŒ10å€ã«ãªã‚‹. æœ¬å½“ã«ãªã‹ã£ãŸã¨ãã ã‘è‡ªåˆ†ã§æ›¸ã. è‡ªåˆ†ã§æ›¸ã‘ã°è¦‹ä»˜ã‹ã‚‹.</p>
<p>çš† jq ä½¿ã£ã¨ã‚‹. ä½¿ã£ã¨ã‚‰ã‚“ã®ãŠå‰ã ã‘.</p>
<p><a href="https://jqlang.github.io/jq/manual/">å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ</a> ã‚’å¸¸ã«é–‹ã„ã¦ãŠã„ã¦ Ctrl+f ã™ã‚‹.</p>
<p>ã‚„ã‚ŠãŸã„ã“ã¨ã‹ã‚‰æ–¹æ³•ã‚’å¼•ããŸã‚ã« Stack Overflow ã‚’æ¤œç´¢ã™ã‚‹.
ã¡ã‚ƒã‚“ã¨ãƒ•ãƒ¬ãƒ¼ãƒ ä»˜ã‘ã‚‰ã‚ŒãŸè³ªå•ã«å¯¾ã—è§£æ±ºæ–¹æ³•ã¨åŸç†åŸå‰‡ã‹ã‚‰ã®è§£èª¬ãŒæ›¸ã‹ã‚Œã¦ã„ã‚‹ç­”ã ã‘ãŒãƒ™ã‚¹ãƒˆã‚¢ãƒ³ã‚µãƒ¼ã .</p>
<h2 id="ji-ben-noki">åŸºæœ¬ã®ã</h2>
<p>pretty print ã§ãã‚‹. (è§£èª¬ã¯ã—ãªã„.)</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>$ cat test_result.json | jq -C .
</span></code></pre>
<h2 id="jq-test">jq '.test'</h2>
<p>èˆˆå‘³ãŒã‚ã‚‹ã®ã¯ <code>.test</code> ã¨ã„ã†éƒ¨åˆ†ã®ã¿ã§ã‚ã‚‹.</p>
<p>ç‰¹å®šãƒ‘ã‚¹ã‚’æŠœã:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>$ cat test_result.json | jq &#39;.tests&#39; | head -n 10
</span><span>{
</span><span>  &quot;virtual&quot;: {
</span><span>    &quot;hoge&quot;: {
</span><span>      &quot;http&quot;: {
</span><span>        &quot;tests&quot;: {
</span><span>          &quot;protocol&quot;: {
</span><span>            &quot;domain0&quot;: {
</span><span>              &quot;test0.js&quot;: {
</span><span>                &quot;expected&quot;: &quot;PASS&quot;,
</span><span>                &quot;actual&quot;: &quot;SKIP&quot;,
</span></code></pre>
<p><a href="https://jqlang.github.io/jq/manual/#basic-filters">https://jqlang.github.io/jq/manual/#basic-filters</a></p>
<p>jq ã¯ command line ã‚„ grep/sed/awk/perl ã‚„ Lisp ã¿ãŸã„ãªã‚‚ã®ã§, ãƒ•ã‚£ãƒ«ã‚¿ã‚’ç¹‹ã’ã‚‹ã®ãŒåŸºæœ¬ã§ã‚ã‚‹.</p>
<h2 id="ru-rezi-ninatuteiru-object-wo-flatten-suru">å…¥ã‚Œå­ã«ãªã£ã¦ã„ã‚‹ object ã‚’ flatten ã™ã‚‹</h2>
<p>å…¥ã‚Œå­ã® object ã¯ jq ã§å‡¦ç†ã—ã«ããã†ã§ã‚ã‚‹. object ã‚’ deep flatten ã—ãŸã„. ã¨ã‚Šã‚ãˆãš 1 level flatten ã—ãŸã„.</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>$ cat test_result.json | jq &#39;.tests&#39; | jq &lt;something&gt;
</span><span>{
</span><span>  &quot;virtual/hoge&quot;: {
</span><span>    &quot;http&quot;: {
</span><span>      &quot;tests&quot;: {
</span></code></pre>
<p>ã¾ã æ—©ã„. ãƒ¬ãƒ™ãƒ«ã‚’ä¸Šã’ã¦å‡ºç›´ã—ã¦å‚ã‚Œ.</p>
<h2 id="object-items-map-f-collect"><code>object.items().map(f).collect()</code></h2>
<p>ä»–ã®è¨€èªã§ã‚‚ object (<code>HashMap</code> ãªã©) ã‚’ iterate ã™ã‚‹ã«ã¯ <code>object.items()</code> ãªã©ã§ iterator ã‚’ä½¿ã£ã¦é †ã«å‡¦ç†ã™ã‚‹.</p>
<p>jq ã‚‚ arary ã¯ map ã§ãã‚‹ãŒ object ã¯ array ã«å¤‰æ›ã—ã¦ã‹ã‚‰ map ã™ã‚‹.</p>
<p><a href="https://jqlang.github.io/jq/manual/#to_entries-from_entries-with_entries">https://jqlang.github.io/jq/manual/#to_entries-from_entries-with_entries</a></p>
<p><code>with_entries(f)</code> is <code>to_entries | map(f) | from_entries</code> ã§ã‚ã‚‹.</p>
<h2 id="ru-rezi-ninatuteiru-object-wo-flatten-suru-2">å…¥ã‚Œå­ã«ãªã£ã¦ã„ã‚‹ object ã‚’ flatten ã™ã‚‹ 2</h2>
<ol>
<li><a href="https://stackoverflow.com/a/24710337">https://stackoverflow.com/a/24710337</a></li>
<li><a href="https://stackoverflow.com/a/74789205">https://stackoverflow.com/a/74789205</a></li>
<li><a href="https://stackoverflow.com/a/74791148">https://stackoverflow.com/a/74791148</a></li>
</ol>
<p>ã“ã‚Œã‚‰ãŒè¿‘ãã†ã§ã‚ã‚‹. ãµãŸã¤ã‚ã¯æ·±ã•ãŒæ—¢çŸ¥ã§å›ºå®šã¨ã„ã†åˆ¶ç´„ãŒã‚ã‚‹.
ã¿ã£ã¤ã‚ã¯å†…å´ã® object ã® key ãŒã²ã¨ã¤ã§ãªã‘ã‚Œã°ãªã‚‰ãªã„ã¨ã„ã†åˆ¶ç´„ãŒã‚ã‚‹.
ã‚ˆã£ã¦ã²ã¨ã¤ã‚ã‚’çœŸä¼¼ã‚‹.</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>$ cat test_result.json | jq &#39;.tests&#39; | jq &#39;. | to_entries | map(.key as $parent_key | .value | to_entries | map(.key |= $parent_key + &quot;/&quot; + .))&#39; | jq -C . | head -n 10
</span><span>[
</span><span>  [
</span><span>    {
</span><span>      &quot;key&quot;: &quot;virtual/hoge&quot;,
</span><span>      &quot;value&quot;: {
</span><span>        &quot;http&quot;: {
</span><span>          &quot;tests&quot;: {
</span><span>            &quot;protocol&quot;: {
</span><span>              &quot;domain0&quot;: {
</span><span>                &quot;test0.js&quot;: {
</span></code></pre>
<ul>
<li>ã²ã¨ã¤ã‚ã® <code>. to_entries | map(</code> ã§å¤–å´ã® <code>object.items().map(</code> ã—,</li>
<li><code>.key as $parent_key</code> ã§å¤–å´ã® key ã‚’æŸç¸›ã—, [<a href="https://jqlang.github.io/jq/manual/#variable-symbolic-binding-operator">doc</a>]</li>
<li>ãµãŸã¤ã‚ã® <code>.value | to_entries | map(</code> ã§å†…å´ã® <code>object.items().map(</code> ã—</li>
<li><code>.key |= $parent_key + "/" + .</code> ã§ key ã ã‘å¼„ã£ãŸ iterator ã‚’å¾—ã‚‹. [<a href="https://jqlang.github.io/jq/manual/#addition">doc</a>]</li>
</ul>
<p>äºŒé‡ã« map ã—ã¦ã„ã‚‹ã®ã§å‡ºåŠ›ã¯2æ¬¡å…ƒé…åˆ—ã«ãªã£ã¦ã„ã‚‹. ãªã®ã§ã‚ã¨ã¯ <code>flatten</code> ã—ã¦ <code>from_entries</code> ã§å…ƒã«æˆ»ã™.</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>$ cat test_result.json | jq &#39;.tests&#39; | jq &#39;. | to_entries | map(.key as $parent_key | .value | to_entries | map(.key |= $parent_key + &quot;/&quot; + .)) | flatten | from_entries&#39; | jq -C . | head -n 10
</span><span>{
</span><span>  &quot;virtual/hoge&quot;: {
</span><span>    &quot;http&quot;: {
</span><span>      &quot;tests&quot;: {
</span><span>        &quot;protocol&quot;: {
</span><span>          &quot;domain0&quot;: {
</span><span>            &quot;test0.js&quot;: {
</span><span>              &quot;expected&quot;: &quot;PASS&quot;,
</span><span>              &quot;actual&quot;: &quot;SKIP&quot;,
</span><span>              &quot;other&quot;: null
</span></code></pre>
<p>ã‚ˆã•ãã†.</p>
<h2 id="kurikaesi">ãã‚Šã‹ãˆã—</h2>
<p>ã‚ã¨ã¯ã“ã‚Œã‚’å¿…è¦ãªã ã‘ç¹°ã‚Šè¿”ã›ã°ã‚ˆã„. ã„ãã¤ã‹æ–¹æ³•ãŒè€ƒãˆã‚‰ã‚Œã‚‹.</p>
<ol type="A">
  <li>çµæœãŒå¤‰ã‚ã‚‰ãªããªã‚‹ã¾ã§ç¹°ã‚Šè¿”ã™ã®ã‚’ã‚·ã‚§ãƒ«èŠ¸ã§ã‚„ã‚‹.</li>
  <li>å‡¦ç†ã™ã¹ã <code>.value</code> ãŒãªããªã‚‹ã¾ã§ç¹°ã‚Šè¿”ã™. (ä¾‹ãˆã°å…¨ã¦ã® <code>.value</code> ãŒ <code>"expected"</code> ã‚’æŒã¤.)</li>
  <li>å…ˆã« JSON ã® max depth ã‚’å–ã£ã¦ãŠã„ã¦ãã®å›æ•°ç¹°ã‚Šè¿”ã™. (1å›ã®å‡¦ç†ã«ã¤ããƒã‚¹ãƒˆãŒã²ã¨ã¤æ¸›ã‚‹ã®ã§.)</li>
</ol>
<p>A. ã¯ã¤ã¾ã‚‰ãªã„ã®ã§ã“ã“ã§ã¯ã‚„ã‚‰ãªã„.</p>
<p>B. ã¯ç´ ç›´ã ãŒå‡¦ç†ãŒå¿…è¦ãªã„ã‚±ãƒ¼ã‚¹ã®åˆ¤å®šãŒå¾®å¦™ã«é‡è¤‡ã—ã¦ã„ã‚‹.</p>
<p>C. ã¯ (depth ãŒå–ã‚Œãªã„ã®ã§) 2 pass èˆã‚ã‚‹å¿…è¦ãŒã‚ã‚‹ãŒæ±ç”¨çš„ã«ãªã‚Šãã†.</p>
<p>B. ãŠã‚ˆã³ C. ã‚’è©¦ã™.</p>
<h3 id="b-chu-li-subeki-value-ganakunarumadezao-rifan-su-li-ebaquan-teno-value-ga-expected-wochi-tu">B. å‡¦ç†ã™ã¹ã <code>.value</code> ãŒãªããªã‚‹ã¾ã§ç¹°ã‚Šè¿”ã™. (ä¾‹ãˆã°å…¨ã¦ã® <code>.value</code> ãŒ <code>"expected"</code> ã‚’æŒã¤.)</h3>
<ul>
<li>åˆ†å²ã¯ if-then-else-end [<a href="https://jqlang.github.io/jq/manual/#if-then-else-end">doc</a>] ãŒã‚ã‚‹.</li>
<li>ãƒ«ãƒ¼ãƒ—ã¯ while [<a href="https://jqlang.github.io/jq/manual/#while">doc</a>] ã‚„ until [<a href="https://jqlang.github.io/jq/manual/#until">doc</a>] ãŒã‚ã‚‹.</li>
<li>all [<a href="https://jqlang.github.io/jq/manual/#all">doc</a>] /any [<a href="https://jqlang.github.io/jq/manual/#any">doc</a>] ã‚‚ã‚ã‚‹.</li>
<li>é–¢æ•°ã‚‚å®šç¾©ã§ãã‚‹. [<a href="https://jqlang.github.io/jq/manual/#defining-functions">doc</a>]</li>
</ul>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>$ cat test_result.json | jq &#39;.tests&#39; | jq &#39;def should_process(x): x | has(&quot;expected&quot;); until(. | to_entries | map(should_process(.value)) | all; . | to_entries | map(.key as $parent_key | if (should_process(.value)) then [.] else (.value | to_entries | map(.key |= $parent_key + &quot;/&quot; + .)) end) | flatten | from_entries)&#39; | jq -C . | head -n 10
</span><span>{
</span><span>  &quot;virtual/hoge/http/tests/protocol/domain0/test0.js&quot;: {
</span><span>    &quot;expected&quot;: &quot;PASS&quot;,
</span><span>    &quot;actual&quot;: &quot;SKIP&quot;,
</span><span>    &quot;other&quot;: null
</span><span>  },
</span><span>  &quot;virtual/hoge/http/tests/protocol/domain0/test1.js&quot;: {
</span><span>    &quot;expected&quot;: &quot;CRASH&quot;,
</span><span>    &quot;actual&quot;: &quot;CRASH&quot;,
</span><span>    &quot;other&quot;: null,
</span></code></pre>
<p>ã‚ˆã•ãã†.</p>
<h3 id="while-to-until-nowei-i">while ã¨ until ã®é•ã„</h3>
<p>é©šãã®äº‹å®Ÿãªã®ã ãŒ, <code>while(condition; f)</code> ã¨ <code>until(condition | not; f)</code> ã¯ç­‰ä¾¡ã§ã¯ãªã„.</p>
<p><code>while(condition; f)</code> ã¯ <code>condition</code> ãŒæº€ã•ã‚Œãªããªããªã‚‹ã¾ã§ <code>f</code> ã‚’ç¹°ã‚Šè¿”ã—é©ç”¨ã—, æº€ãŸã•ãªããªã£ãŸã‚‚ã®ã¯å‡ºåŠ›ã•ã‚Œãªã„.
ã¤ã¾ã‚Š <code>. | f^n</code> ãŒåˆã‚ã¦ <code>condition</code> ã‚’æº€ãŸã•ãªã„ã¨ã, <code>. | f</code>, <code>. | f^2</code>, ..., <code>. | f^{n-1}</code> ã‚’å‡ºåŠ›ã™ã‚‹.</p>
<p><code>until(condition | not; f)</code> ã¯ <code>condition</code> ãŒæº€ã•ã‚Œãªããªããªã‚‹ã¾ã§ <code>f</code> ã‚’ç¹°ã‚Šè¿”ã—é©ç”¨ã—, åˆã‚ã¦æº€ãŸã•ãªããªã£ãŸã‚‚ã®ã®ã¿ã‚’å‡ºåŠ›ã™ã‚‹.
ã¤ã¾ã‚Š <code>. | f^n</code> ã‚’å‡ºåŠ›ã™ã‚‹.</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>$ echo 1 | jq &#39;[while(. &lt; 100; . * 2)]&#39;
</span><span>[
</span><span>  1,
</span><span>  2,
</span><span>  4,
</span><span>  8,
</span><span>  16,
</span><span>  32,
</span><span>  64
</span><span>]
</span><span>
</span><span>$ echo 1 | jq &#39;while(. &lt; 100; . * 2)&#39;
</span><span>1
</span><span>2
</span><span>4
</span><span>8
</span><span>16
</span><span>32
</span><span>64
</span><span>
</span><span>$ echo 1 | jq &#39;[until(. &lt; 100 | not; . * 2)]&#39;
</span><span>[
</span><span>  128
</span><span>]
</span><span>
</span><span>$ echo 1 | jq &#39;until(. &lt; 100 | not; . * 2)&#39;
</span><span>128
</span></code></pre>
<p>ã“ã‚Œãƒã‚¸!?</p>
<p>(jq Manual ã® "See advanced topics below." ã£ã¦ã©ã“ã‚’è¦‹ã‚Œã°ã„ã„ã‚“ã ?)</p>
<p>ã ã‹ã‚‰ until ã‚’ä½¿ã†å¿…è¦ãŒã‚ã£ãŸã‚“ã§ã™ã­.</p>
<h2 id="c-xian-ni-json-no-max-depth-woqu-tuteoitesonohui-shu-zao-rifan-su-1hui-nochu-li-nitukinesutogahitotujian-runode">C. å…ˆã« JSON ã® max depth ã‚’å–ã£ã¦ãŠã„ã¦ãã®å›æ•°ç¹°ã‚Šè¿”ã™. (1å›ã®å‡¦ç†ã«ã¤ããƒã‚¹ãƒˆãŒã²ã¨ã¤æ¸›ã‚‹ã®ã§.)</h2>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>$ echo &#39;0\n&quot;hoge&quot;\n[]\n{}\n[{&quot;a&quot;: []}, 1]\n[{&quot;a&quot;: []}, [{&quot;b&quot;: 1}, {&quot;c&quot;: {&quot;d&quot;: 1}}]]\n&#39; | jq &#39;def depth(x): if (. | [type] | inside([&quot;array&quot;, &quot;object&quot;]) | not) then 0 else ({depth: 0, xs: [x]} | until((.xs | length) == 0; {depth: (.depth + 1), xs: (.xs | map(if (. | type == &quot;array&quot;) then . else (if (. | type == &quot;object&quot;) then (to_entries | map(.value)) else [] end) end) | flatten)}) | .depth) end; depth(.)&#39;
</span><span>0
</span><span>0
</span><span>1
</span><span>1
</span><span>2
</span><span>4
</span></code></pre>
<p>ã¯ã„. BFS ã£ã½ã root ã‹ã‚‰ <code>{depth, xs}</code> ã‚’æŒã¡å›ã£ã¦ç©ºã«ãªã‚‹ã¾ã§ <code>depth &lt;- depth + 1; xs &lt;- xs.map(children).flatten()</code> ã™ã‚‹ã ã‘ã§ã™ã­.</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>$ cat test_result.json | jq &#39;.tests&#39; | jq &#39;def depth(x): if (. | [type] | inside([&quot;array&quot;, &quot;object&quot;]) | not) then 0 else ({depth: 0, xs: [x]} | until((.xs | length) == 0; {depth: (.depth + 1), xs: (.xs | map(if (. | type == &quot;array&quot;) then . else (if (. | type == &quot;object&quot;) then (to_entries | map(.value)) else [] end) end) | flatten)}) | .depth) end; def should_process(x): x | has(&quot;expected&quot;); {i: depth(.), x: .} | until(.i == 0; {i: (.i - 1), x: (.x | to_entries | map(.key as $parent_key | if (should_process(.value)) then [.] else (.value | to_entries | map(.key |= $parent_key + &quot;/&quot; + .)) end) | flatten | from_entries)}) | .x&#39; | jq -C . | head -n 10
</span><span>{
</span><span>  &quot;virtual/hoge/http/tests/protocol/domain0/test0.js&quot;: {
</span><span>    &quot;expected&quot;: &quot;PASS&quot;,
</span><span>    &quot;actual&quot;: &quot;SKIP&quot;,
</span><span>    &quot;other&quot;: null
</span><span>  },
</span><span>  &quot;virtual/hoge/http/tests/protocol/domain0/test1.js&quot;: {
</span><span>    &quot;expected&quot;: &quot;CRASH&quot;,
</span><span>    &quot;actual&quot;: &quot;CRASH&quot;,
</span><span>    &quot;other&quot;: null,
</span></code></pre>
<p>ã‚ˆã•ãã†.</p>
<h2 id="jie-ju-yu-sikatutamono">çµå±€æ¬²ã—ã‹ã£ãŸã‚‚ã®</h2>
<p>å°‘ã—ã ã‘çŸ­ã‹ã„ B. ã‚’ä½¿ã†. ã‚ã¨ã¯ã¡ã‚‡ã‚ã£ã¨ãƒ•ã‚£ãƒ«ã‚¿ã™ã‚‹ã ã‘ã§ã‚ã‚‹.</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>$ cat test_result.json | jq &#39;.tests&#39; | jq &#39;def should_process(x): x | has(&quot;expected&quot;); until(. | to_entries | map(should_process(.value)) | all; . | to_entries | map(.key as $parent_key | if (should_process(.value)) then [.] else (.value | to_entries | map(.key |= $parent_key + &quot;/&quot; + .)) end) | flatten | from_entries)&#39; | jq &#39;. | with_entries({&quot;key&quot;: .key, &quot;value&quot;: {&quot;expected&quot;: .value.expected, &quot;actual&quot;: .value.actual}})&#39; | jq &#39;with_entries(select(.value.actual != &quot;SKIP&quot;))&#39; | jq &#39;with_entries(select(.value.actual != .value.expected))&#39; | jq -C .
</span><span>{
</span><span>  &quot;virtual/hoge/http/tests/protocol/domain1/test0.js&quot;: {
</span><span>    &quot;expected&quot;: &quot;PASS&quot;,
</span><span>    &quot;actual&quot;: &quot;FAIL&quot;
</span><span>  }
</span><span>}
</span></code></pre>
<p>ãˆãˆã‚„ã‚“!! ã“ã†ã„ã†ã®ãŒæ¬²ã—ã‹ã£ãŸ!!</p>
<p>ã§, ã“ã‚Œã©ã†ã‚„ã£ã¦ãƒ¡ãƒ³ãƒ†ã™ã‚‹ã‚“ã ã‚...?</p>

    </div>
</article>

            </main>
            <footer>
                <div class="footer">
                    <small class="footer-left">
                        Â© 2021--2024. All rights reserved.
                    </small>
                    <small class="footer-right">
                        Powered by <a href="https://www.getzola.org">Zola</a>
                    </small>
                </div>
            </footer>
        </div>
    </body>
</html>
