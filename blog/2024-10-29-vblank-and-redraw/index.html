<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title>
memo: Wayland compositor ã¨ redraw ã¨ VBlank | å†·ãŸãæ²¢ã®å²©é™°ã®
</title>

        
<meta property="og:image" content="https:&#x2F;&#x2F;kenoss.github.io&#x2F;ogp.jpg" />
<meta property="og:title" content="memo: Wayland compositor ã¨ redraw ã¨ VBlank" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https:&#x2F;&#x2F;kenoss.github.io&#x2F;blog&#x2F;2024-10-29-vblank-and-redraw&#x2F;" />

<meta property="og:site_name" content="å†·ãŸãæ²¢ã®å²©é™°ã®" />

<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@keno_ss" />


        



        <link rel="stylesheet" href="https://kenoss.github.io/theme.css">
    </head>
    <body>
        <div class="content">
            <header>
                <div class="header-left">
                    <a href="https:&#x2F;&#x2F;kenoss.github.io" class="header-logo">å†·ãŸãæ²¢ã®å²©é™°ã®</a>
                </div>
                <div class="header-right">
                </div>
            </header>
            <main>
                
<article itemscope itemtype="http://schema.org/BlogPosting">
    <div class="headline" itemprop="headline">
        <h1 class="post-title">memo: Wayland compositor ã¨ redraw ã¨ VBlank</h2>
        <div class="border"></div>
        <div>
            <time datetime="2024-10-29" class="post-date" itemprop="datePublished">
                2024-10-29
            </time>
            
                |
                
                    <span class="post-tag">ğŸ¦€ memo</span>
                
                    <span class="post-tag">ğŸ¦€ tech</span>
                
                    <span class="post-tag">ğŸ¦€ wayland-compositor</span>
                
                        
        </div>
    </div>
    <div itemprop="articleBody">
        <h2 id="anvil-vs-niri">Anvil vs niri</h2>
<p><a href="https://github.com/Smithay/smithay">smithay</a> crate ã¯ Rust ã§ Wayland ã‚’æ‰±ãˆã‚‹ç´ æ™´ã‚‰ã—ã„ crate ã§ã™.</p>
<p>ã§ã™ãŒä»˜å±ã® Wayland compositor å®Ÿè£…ã§ã‚ã‚‹ <a href="https://github.com/Smithay/smithay/tree/master/anvil">Anvil</a> ãŒ
(<a href="https://github.com/YaLTeR/niri">niri ã¨æ¯”è¼ƒã™ã‚‹ã¨</a>) ã‹ãªã‚Šèª­ã¿ã«ãã„ã¨ã„ã†å•é¡ŒãŒã‚ã‚Šã¾ã™.
ãã®ä¸€å› ã¨ã—ã¦ backend (udev, winit) ãŒæŠ½è±¡çš„ã«åˆ†é›¢ã•ã‚Œã¦ã„ãªã„ã¨ã„ã†ã®ãŒã‚ã‚‹æ°—ãŒã—ã¾ã™.
ã“ã®ã¸ã‚“ã‚’æ•´ç†ã—ã¦ã„ãŸã®ã§ã™ãŒ udev backend ã¨ winit backend ã§ redraw ã®å‡¦ç†ãŒã‹ãªã‚Šé•ã†ã®ãŒãƒãƒƒã‚¯ã«ãªã£ã¦ãã¾ã—ãŸ.</p>
<p>ã¨ã„ã†ã‚ã‘ã§èª¿æŸ»ã¨æ¯”è¼ƒã™ã‚‹ã­. <a href="https://www.nicovideo.jp/watch/sm39360075">ã¯ã„ã©ã†ãï¼</a></p>
<h2 id="niri">niri</h2>
<p><a href="https://github.com/YaLTeR/niri/tree/f203c8729a8535f6a317df5a35dc01306be2e45c">https://github.com/YaLTeR/niri/tree/f203c8729a8535f6a317df5a35dc01306be2e45c</a></p>
<p><a href="https://github.com/YaLTeR/niri/blob/f203c8729a8535f6a317df5a35dc01306be2e45c/src/main.rs#L261-L263">https://github.com/YaLTeR/niri/blob/f203c8729a8535f6a317df5a35dc01306be2e45c/src/main.rs#L261-L263</a></p>
<p>niri ã¯ <a href="https://docs.rs/calloop/latest/calloop/struct.EventLoop.html#method.run">calloop::EventLoop::run()</a>
ã§ãƒ«ãƒ¼ãƒ—ã‚’é§†å‹•ã—ã¦ã„ã‚‹. ä¸­ã® <a href="https://docs.rs/calloop/latest/calloop/struct.EventLoop.html#method.dispatch">dispatch()</a>
ã§ Wayland client ã‹ã‚‰ã®ã‚¤ãƒ™ãƒ³ãƒˆãªã©ã‚‚å‡¦ç†ã—ã¦ã„ã‚‹. <code>niri::State::refresh_and_flush_clients()</code> ã‹ã‚‰
<a href="https://github.com/YaLTeR/niri/blob/f203c8729a8535f6a317df5a35dc01306be2e45c/src/niri.rs#L2708">niri::Backend::render()</a>
ãŒå‘¼ã³å‡ºã•ã‚Œã‚‹.</p>
<p>tty backend ã®å ´åˆã¯
<a href="https://github.com/YaLTeR/niri/blob/f203c8729a8535f6a317df5a35dc01306be2e45c/src/backend/tty.rs#L1274">DrmCompositor::render_frame()</a>
ã¨
<a href="https://github.com/YaLTeR/niri/blob/f203c8729a8535f6a317df5a35dc01306be2e45c/src/backend/tty.rs#L1300">DrmCompositor::queue_frame()</a>
ãŒå‘¼ã³å‡ºã•ã‚Œã‚‹. ã—ã‹ã—ã“ã®ãƒ«ãƒ¼ãƒ—ã‚’æ„šç›´ã«å›ã™ã¨ä»¥ä¸‹ã®å•é¡ŒãŒå‡ºã¦ã—ã¾ã†.</p>
<ol>
<li>ãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ã® FPS ã‚’ä¸Šå›ã‚‹é »åº¦ã§ render ã—ã¦ã—ã¾ã†.</li>
<li>rerender ã®å¿…è¦ãŒãªã„ã®ã« render ã—ã¦ã—ã¾ã†. (è¡¨ç¤ºã—ã¦ã„ã‚‹ã©ã®ã‚¦ã‚¤ãƒ³ãƒ‰ã‚¦ã‚‚æ›´æ–°ãŒãªã„å ´åˆãªã©.)</li>
</ol>
<p>1.ã¯ VBlank ã‚’ä½¿ã£ã¦è§£æ±ºã™ã‚‹.
redraw ã¯ <a href="https://github.com/YaLTeR/niri/blob/f203c8729a8535f6a317df5a35dc01306be2e45c/src/niri.rs#L314">niri::RedrawState</a>
ã‚’ä½¿ã£ã¦ç®¡ç†ã•ã‚Œã¦ã„ã‚‹. frame ãŒ scan-out ã•ã‚ŒãŸã‚‰
<a href="https://github.com/YaLTeR/niri/blob/f203c8729a8535f6a317df5a35dc01306be2e45c/src/backend/tty.rs#L557">DrmEvent::VBlank</a>
ãŒé€šçŸ¥ã•ã‚Œã‚‹ã®ã§ã“ã“ã§
<a href="https://github.com/YaLTeR/niri/blob/f203c8729a8535f6a317df5a35dc01306be2e45c/src/backend/tty.rs#L1154">redraw state ã‚’ Idle ã«ã™ã‚‹</a>.
<a href="https://github.com/YaLTeR/niri/blob/f203c8729a8535f6a317df5a35dc01306be2e45c/src/niri.rs#L2223-L2226">redraw state ãŒ Idle ã®ã‚‚ã®ã¯ skip ã•ã‚Œã‚‹</a>
ã®ã§ç„¡é§„ãª render ãŒæŠ‘ãˆã‚‰ã‚Œã‚‹ã¨ã„ã†ãƒ¯ã‚±.</p>
<p>2.ã¯ <code>wl_surface::commit</code> ãªã©ã‚’ä½¿ã£ã¦è§£æ±ºã™ã‚‹.
<a href="https://github.com/YaLTeR/niri/blob/f203c8729a8535f6a317df5a35dc01306be2e45c/src/handlers/compositor.rs#L193">CompositorHandler::commit()</a>,
ã¤ã¾ã‚Š
<a href="https://github.com/Smithay/smithay/blob/8e49b9bb1849f0ead1ba2c7cd76802fc12ad6ac3/src/wayland/compositor/handlers.rs#L248-L252">wl_surface::commit</a>
ãŒå‘¼ã°ã‚Œã‚‹ã¨ãã«
<a href="https://github.com/YaLTeR/niri/blob/f203c8729a8535f6a317df5a35dc01306be2e45c/src/handlers/compositor.rs#L193">niri::Niri::queue_redraw()</a>
ã™ã‚‹.</p>
<p>ä»–ã«ã‚‚ <code>queue_redraw()</code> ã‚’å‘¼ã‚“ã§ã„ã‚‹ã¨ã“ã‚ã¯ãŸãã•ã‚“ã‚ã‚‹. ä¾‹ãˆã°ã‚¦ã‚¤ãƒ³ãƒ‰ã‚¦ã‚’æ´ã‚“ã§ç§»å‹•ã—ã¦ã„ã‚‹ã¨ããªã©ã¯ã‚¦ã‚¤ãƒ³ãƒ‰ã‚¦ã®å†…å®¹è‡ªä½“ã¯å¤‰ã‚ã£ã¦ã„ã‚‹ã¨ã¯é™ã‚‰ãªã„ã®ã§
<code>queue_redraw()</code> ã™ã‚‹å¿…è¦ãŒã‚ã‚‹.</p>
<p>ã“ã®æ§˜ã«, redraw ã‚’æŠ‘åˆ¶ã—, å¿…è¦ãŒã‚ã‚‹ã¨ãã ã‘ç™ºç«ã•ã›ã‚‹ã¨ã„ã†æ„Ÿã˜ã§ã‚„ã£ã¦ã„ã‚‹. ä¸Šæ‰‹ã„ã­.</p>
<p>å› ã¿ã«ã“ã®æŒ™å‹•ã¯ terminal ã‚’é–‹ã„ã¦ <code>for i in $(seq 0 10000); do echo $i; sleep 1; done</code> ã¨ã‹ã‚„ã‚‹ã¨ã‚ã‹ã‚Šã‚„ã™ã„.</p>
<p>æ³¨æ„ã¨ã—ã¦ã¯, niri ã¯ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚‚ã‚ã‚‹ã®ã§
<a href="https://github.com/YaLTeR/niri/blob/f203c8729a8535f6a317df5a35dc01306be2e45c/src/backend/tty.rs#L1162">ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ä¸­ã¯ redraw ã‚’ç¶šã‘ã‚‹</a>
ã¨ã„ã£ãŸå‡¦ç†ã‚‚å¿…è¦ã«ãªã‚‹ã‚ãŸã‚Šã‹.</p>
<p>winit backend ã‚‚åŸºæœ¬ã¯åŒã˜ã ãŒ, (åƒ•ã®ç†è§£ã§ã¯) VBlank é€šçŸ¥ã«ç›¸å½“ã™ã‚‹ frame callback ã‚’å¾…ãŸãšã«
<a href="https://github.com/YaLTeR/niri/blob/f203c8729a8535f6a317df5a35dc01306be2e45c/src/backend/winit.rs#L236-L240">winit::window::Window::request_redraw() ã—ã¦ã„ã‚‹</a>.</p>
<h2 id="anvil">Anvil</h2>
<p><a href="https://github.com/Smithay/smithay/tree/8e49b9bb1849f0ead1ba2c7cd76802fc12ad6ac3">https://github.com/Smithay/smithay/tree/8e49b9bb1849f0ead1ba2c7cd76802fc12ad6ac3</a></p>
<p>udev/winit backend ã¯ãã‚Œãã‚Œç•°ãªã‚‹ãƒ«ãƒ¼ãƒ—ã‚’æŒã¤.</p>
<p>ã¾ãšã¯ udev backend ã®æ–¹.</p>
<p><a href="https://github.com/Smithay/smithay/blob/8e49b9bb1849f0ead1ba2c7cd76802fc12ad6ac3/anvil/src/udev.rs#L486">main ã®ãƒ«ãƒ¼ãƒ—</a>
ã‚’æŒã¤ã“ã¨è‡ªä½“ã¯åŒã˜. ã“ã‚Œã¯ç°¡å˜ã« <code>calloop::EventLoop::run()</code> ã«ç½®ãæ›ãˆå¯èƒ½ã§ã‚ã‚‹.
ã•ã¦, ã“ã® main ãƒ«ãƒ¼ãƒ—è‡ªä½“ã¯ rendering ã«çµ¡ã¾ãªã„. å®Ÿã¯ã‚‚ã†ã²ã¨ã¤ rendering ç”¨ã®ãƒ«ãƒ¼ãƒ—ãŒå­˜åœ¨ã™ã‚‹.</p>
<ul>
<li><a href="https://github.com/Smithay/smithay/blob/8e49b9bb1849f0ead1ba2c7cd76802fc12ad6ac3/anvil/src/udev.rs#L1361">UdevData::render()</a></li>
<li>-&gt; <a href="https://github.com/Smithay/smithay/blob/8e49b9bb1849f0ead1ba2c7cd76802fc12ad6ac3/anvil/src/udev.rs#L1505-L1510">oneshot timer</a> if reschedule; or</li>
<li>-&gt; <a href="https://github.com/Smithay/smithay/blob/8e49b9bb1849f0ead1ba2c7cd76802fc12ad6ac3/anvil/src/udev.rs#L866">VBlank</a></li>
<li>---&gt; <a href="https://github.com/Smithay/smithay/blob/8e49b9bb1849f0ead1ba2c7cd76802fc12ad6ac3/anvil/src/udev.rs#L1351-L1356">oneshot timer</a></li>
</ul>
<p>ã“ã® oneshot timer ã®ã©ã¡ã‚‰ã‹ã‚’ä½•ã‚‰ã‹ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã‚„ã‚ã‚‹ã¨æç”»ã•ã‚Œãªããªã‚‹. (æŒ™å‹•ãŒã‚ã¡ã‚ƒãã¡ã‚ƒè¿½ã„ã«ãã„. ã‚‚ã†ã¡ã‚‡ã£ã¨ãªã‚“ã¨ã‹ãªã‚‰ã‚“ã‹ã£ãŸã‚“ã‹?)</p>
<p>ã“ã®ãƒ«ãƒ¼ãƒ—ã¯æ¦‚ã­ 1/FPS ç§’ã”ã¨ã«1å‘¨ã™ã‚‹. scan-out ã•ã‚Œã‚‹ãƒ‘ã‚¹ã¯ VBlank ã«å…¥ã‚‹ãŒ, scan-out ã•ã‚Œãªã„ã‚±ãƒ¼ã‚¹ã§ã‚‚ (ä¾‹ãˆã° <code>DrmCompositor</code> ã‚’ä½¿ã£ã¦ã„ã‚‹å ´åˆ)
<a href="https://smithay.github.io/smithay/smithay/backend/drm/compositor/struct.DrmCompositor.html#method.render_frame">DrmCompositor::render_frame()</a>
ãŒå‘¼ã³å‡ºã•ã‚Œã‚‹. (è©³ã—ããªã„ã®ã ã‘ã‚Œã©, æ¶ˆè²»é›»åŠ›ã¨ã‹å¤§ä¸ˆå¤«ãªã‚“ã§ã™ã‹ã­...?)</p>
<p>ã“ã®ãƒ«ãƒ¼ãƒ—ãŒåˆ‡ã‚Šé›¢ã•ã‚Œã¦ã„ã‚‹ã‹ã‚‰ main ãƒ«ãƒ¼ãƒ—ãŒç°¡ç´ ã¨ã„ã†ãƒ¯ã‚±.</p>
<p>winit backend ã®å ´åˆ
<a href="https://github.com/Smithay/smithay/blob/8e49b9bb1849f0ead1ba2c7cd76802fc12ad6ac3/anvil/src/winit.rs#L248">main ãƒ«ãƒ¼ãƒ—ã®ä¸­ã§ render ã—ã¦ã„ã‚‹</a>.
ã“ã®é•ã„ãŒ backend ã‚’ <code>state</code> ã‹ã‚‰åˆ†é›¢ã™ã‚‹ã®ã‚’é›£ã—ãã—ã¦ã„ã‚‹.</p>
<h2 id="mutter-gtk">Mutter (GTK)</h2>
<p><a href="https://gitlab.gnome.org/GNOME/mutter">https://gitlab.gnome.org/GNOME/mutter</a></p>
<p>èª­ã‚‚ã†ã¨ã—ãŸã‘ã©ã¾ã£ãŸãã‚ã‹ã‚‰ã‚“. C è¨€èªã¨ GObject é›£ã—ã™ãã²ã‚“?</p>
<h2 id="kwin-kde">KWin (KDE)</h2>
<p><a href="https://github.com/KDE/kwin/tree/v6.2.2">https://github.com/KDE/kwin/tree/v6.2.2</a></p>
<p>ã“ã“ã‹ã‚‰é›‘åº¦ãŒä¸ŠãŒã‚‹.</p>
<p><a href="https://github.com/KDE/kwin/blob/v6.2.2/src/main_wayland.cpp#L630">main ãƒ«ãƒ¼ãƒ—ã¯ã“ã“</a> ã§, ãã‚Œã¨ã¯åˆ¥ã«
<a href="https://github.com/KDE/kwin/blob/v6.2.2/src/backends/wayland/wayland_output.h#L92">WaylandOutput ãŒ RenderLoop ã‚’ä¿æŒã—ã¦ã„ã‚‹</a>.
<code>RenderLoop</code> ã¯ <a href="https://github.com/KDE/kwin/blob/v6.2.2/src/core/renderloop.cpp#L34-L41">ãµãŸã¤ timer ã‚’æŒã£ã¦ã„ã‚‹</a>.
ãµãŸã¤ã‚ã® timer ã®ã“ã¨ã¯å¿˜ã‚Œã‚ˆã†. (ä»–ã« <code>RenderLoop::scheduleRepaint()</code> ã‚’å‘¼ã³å‡ºã—ã¦ã„ã‚‹ã®, <code>DrmOutput</code> ã ã‘ã ã—.)</p>
<ul>
<li><code>compositeTimer</code></li>
<li>-&gt; <a href="https://github.com/KDE/kwin/blob/v6.2.2/src/core/renderloop.cpp#L190">call frameRequested()</a></li>
<li>-&gt; <a href="https://github.com/KDE/kwin/blob/v6.2.2/src/compositor.cpp#L89">RenderLoop::frameRequested() -&gt; Compositor::handleFrameRequested()</a></li>
<li>-&gt; <a href="https://github.com/KDE/kwin/blob/v6.2.2/src/compositor_wayland.cpp#L295">WaylandCompositor::composite(</a>]</li>
<li>-&gt; <a href="https://github.com/KDE/kwin/blob/v6.2.2/src/compositor_wayland.cpp#L372">call paintPass()</a></li>
<li>-&gt; VBlank</li>
<li>-&gt; <a href="https://github.com/KDE/kwin/blob/v6.2.2/src/backends/wayland/wayland_output.cpp#L128">KWayland::Client::Surface::frameRendered() -&gt; OutputFrame::presented()</a></li>
<li>-&gt; <a href="https://github.com/KDE/kwin/blob/v6.2.2/src/core/renderloop.cpp#L180">RenderLoopPrivate::notifyVblank ã§ lastPresentationTimestamp ã—ã¤ã¤</a></li>
<li>-&gt; <a href="https://github.com/KDE/kwin/blob/v6.2.2/src/core/renderloop.cpp#L162">call RenderLoopPrivate::scheduleRepaint()</a></li>
<li>-&gt; <a href="https://github.com/KDE/kwin/blob/v6.2.2/src/core/renderloop.cpp#L120">compositeTimer.start()</a></li>
</ul>
<p>ã“ã‚Œã§ãƒ«ãƒ¼ãƒ—ã™ã‚‹.</p>
<p>ä¸Šã§ã¯ scan-out ã•ã‚ŒãŸã‚±ãƒ¼ã‚¹ã‚’æ›¸ã„ãŸãŒ, ãã†ã§ãªã„ã‚±ãƒ¼ã‚¹ã¯
<a href="https://github.com/KDE/kwin/blob/v6.2.2/src/core/renderbackend.cpp#L58-L60">OutputFrame::~OutputFrame() ã‹ã‚‰ RenderLoopPrivate::scheduleNextRepaint() ã•ã‚Œã‚‹</a>.</p>
<p>ã¤ã¾ã‚Š Anvil ã¨ã ã„ãŸã„ä¸€ç·’.</p>
<h2 id="matome">ã¾ã¨ã‚</h2>
<p>Anvil ãƒ™ãƒ¼ã‚¹ã®ã‚„ã¤ã‚’æ”¹è‰¯ã—ã‚ˆã†ã¨æ€ã£ãŸã‘ã© KWin ã¨ä¼¼ãŸæ–¹æ³•ã ã—ã“ã‚ŒãŒç‰¹åˆ¥å¤‰ãªã“ã¨ã‚’ã—ã¦ã„ã‚‹ã‚ã‘ã§ã¯ãªã„ã£ã½ã„ã“ã¨ãŒã‚ã‹ã£ã¦ã—ã¾ã£ãŸ.
ã©ã†ã—ã‚ˆã†... (ã¾ãæ§‹é€ ã‚’ã‚­ãƒ¼ãƒ—ã—ã¤ã¤ãƒã‚·ã«ã™ã‚‹ã®ã¯ã©ã†ã¨ã§ã‚‚ã§ãã‚‹æ°—ã¯ã™ã‚‹ãŒ.)</p>

    </div>
</article>

            </main>
            <footer>
                <div class="footer">
                    <small class="footer-left">
                        Â© 2021--2024. All rights reserved.
                    </small>
                    <small class="footer-right">
                        Powered by <a href="https://www.getzola.org">Zola</a>
                    </small>
                </div>
            </footer>
        </div>
    </body>
</html>
