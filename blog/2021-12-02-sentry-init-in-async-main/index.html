<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title>
sentry::init() in anysc main() | å†·ãŸãæ²¢ã®å²©é™°ã®
</title>

        
<meta property="og:image" content="https:&#x2F;&#x2F;kenoss.github.io&#x2F;ogp.jpg" />
<meta property="og:title" content="sentry::init() in anysc main()" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https:&#x2F;&#x2F;kenoss.github.io&#x2F;blog&#x2F;2021-12-02-sentry-init-in-async-main&#x2F;" />

<meta property="og:site_name" content="å†·ãŸãæ²¢ã®å²©é™°ã®" />

<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@keno_ss" />


        



        <link rel="stylesheet" href="https://kenoss.github.io/theme.css">
    </head>
    <body>
        <div class="content">
            <header>
                <div class="header-left">
                    <a href="https:&#x2F;&#x2F;kenoss.github.io" class="header-logo">å†·ãŸãæ²¢ã®å²©é™°ã®</a>
                </div>
                <div class="header-right">
                </div>
            </header>
            <main>
                
<article itemscope itemtype="http://schema.org/BlogPosting">
    <div class="headline" itemprop="headline">
        <h1 class="post-title">sentry::init() in anysc main()</h2>
        <div class="border"></div>
        <div>
            <time datetime="2021-12-02" class="post-date" itemprop="datePublished">
                2021-12-02
            </time>
            
                |
                
                    <span class="post-tag">ğŸ¦€ tech</span>
                
                    <span class="post-tag">ğŸ¦€ rust</span>
                
                        
        </div>
    </div>
    <div itemprop="articleBody">
        <p>ã“ã®è¨˜äº‹ã¯ <a href="https://qiita.com/advent-calendar/2021/rust">Rust Advent Calendar 2021</a> 2æ—¥ç›®ã®è¨˜äº‹ã§ã™.</p>
<h2 id="version-nado">version ãªã©</h2>
<p><a href="https://github.com/getsentry/sentry-rust">https://github.com/getsentry/sentry-rust</a>: <a href="https://github.com/getsentry/sentry-rust/tree/0.23.0">0.23.0</a></p>
<h2 id="sentry-noshi-qian-zhi-shi">Sentry ã®äº‹å‰çŸ¥è­˜</h2>
<p><a href="https://sentry.io/">Sentry</a> ã¯ã‚¨ãƒ©ãƒ¼ã‚„ãƒˆãƒ¬ãƒ¼ã‚¹ãªã©ã®æƒ…å ±ã‚’é›†ç´„ã—ã¦ç®¡ç†ã§ãã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã§ã™.</p>
<p>Sentry ã«ç™»éŒ²ã—ã¦, DSN (API token ã®ã‚ˆã†ãªã‚‚ã®) ã‚’å–å¾—ã—ã¦, ä¾‹ãˆã°</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">main</span><span>() {
</span><span>    </span><span style="color:#b48ead;">let</span><span> _guard = sentry::init(sentry::ClientOptions::default());
</span><span>
</span><span>    sentry::capture_message(&quot;</span><span style="color:#a3be8c;">something wrong</span><span>&quot;, sentry::Level::Error);
</span><span>
</span><span>    panic!(&quot;</span><span style="color:#a3be8c;">explicit panic</span><span>&quot;);
</span><span>}
</span></code></pre>
<p>ã¨ã„ã†ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’ <code>SENTRY_DSN=&lt;dsn&gt; cargo run</code> ã¨ã—ã¦å®Ÿè¡Œã™ã‚‹ã¨ Sentry ã«ã‚¨ãƒ©ãƒ¼ãªã©ã®æƒ…å ±ãŒé€ã‚‰ã‚Œ, Sentry ã® UI ä¸Šã§ãã‚Œã‚‰ã‚’è¦‹ã‚‹ã“ã¨ãŒã§ãã¾ã™.
ã¹ã‚“ã‚Šã§ã™ã­.</p>
<p>ä¾¿åˆ©ãªã®ã§ã‚ˆã web ã‚µãƒ¼ãƒãƒ¼ã®ã‚¨ãƒ©ãƒ¼ã‚’æŠŠæ¡ã—ãŸã‚Šã™ã‚‹ãŸã‚ã«ä½¿ã‚ã‚ŒãŸã‚Šã—ã¾ã™.</p>
<p>ã•ã¦, ä¸Šè¨˜ã® <code>sentry::capture_message()</code> ã‚„ <code>panic!()</code> ã®ã¨ã“ã‚ã§ã¯ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä»¥å¤–ã®æƒ…å ±ã‚’æ¸¡ã—ã¦ã„ã¾ã›ã‚“.
ã‚¨ãƒ©ãƒ¼ã‚’é€ä¿¡ã™ã‚‹ã«ã¯ DSN ã‚„ã‚‰ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½¿ã†ã¯ãšã§ã™.</p>
<p>è£å´ã‚’è¦—ãå‰ã«ç™»å ´äººç‰©ã‚’ç´¹ä»‹ã—ã¦ãŠãã¾ã—ã‚‡ã†.</p>
<ul>
<li><code>Client</code>
<ul>
<li>https://docs.rs/sentry/0.23.0/sentry/struct.Client.html</li>
<li>DSN ã‚’ä¿æŒã—ã¦ãŠã‚Š, å®Ÿéš›ã® <code>capture_event()</code> ã®å‡¦ç†ã‚’è¡Œã„ã¾ã™.</li>
</ul>
</li>
<li><code>Hub</code>
<ul>
<li>https://docs.rs/sentry/0.23.0/sentry/struct.Hub.html</li>
<li>ã‚¹ãƒ¬ãƒƒãƒ‰ã«ç´ä»˜ã„ã¦ãŠã‚Š, æ–‡è„ˆæƒ…å ±ã‚’ä¿æŒã—ã¾ã™. ãã®ä¸­ã«ã¯ <code>Client</code> ãŒå«ã¾ã‚Œã¾ã™. (å¾Œã§ã‚‚ã†å°‘ã—è©³ã—ãèª¬æ˜ã—ã¾ã™.)</li>
</ul>
</li>
</ul>
<p><code>sentry::init()</code> ã‹ã‚‰ <code>sentry::capture_message()</code> ã¾ã§ã®æµã‚Œã¯ä»¥ä¸‹ã®æ§˜ãªæ„Ÿã˜ã§ã™.</p>
<p>https://github.com/getsentry/sentry-rust/blob/0.23.0/sentry/src/init.rs#L91</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#b48ead;">pub fn </span><span style="color:#8fa1b3;">init</span><span>&lt;C&gt;(</span><span style="color:#bf616a;">opts</span><span>: C) -&gt; ClientInitGuard
</span><span style="color:#b48ead;">where
</span><span>    C: Into&lt;ClientOptions&gt;,
</span><span>{
</span><span>    </span><span style="color:#b48ead;">let</span><span> opts = </span><span style="color:#96b5b4;">apply_defaults</span><span>(opts.</span><span style="color:#96b5b4;">into</span><span>());
</span><span>    </span><span style="color:#b48ead;">let</span><span> auto_session_tracking = opts.auto_session_tracking;
</span><span>    </span><span style="color:#b48ead;">let</span><span> session_mode = opts.session_mode;
</span><span>    </span><span style="color:#b48ead;">let</span><span> client = Arc::new(Client::from(opts));
</span><span>
</span><span>    Hub::with(|</span><span style="color:#bf616a;">hub</span><span>| hub.</span><span style="color:#96b5b4;">bind_client</span><span>(Some(client.</span><span style="color:#96b5b4;">clone</span><span>())));
</span><span>    </span><span style="color:#b48ead;">if let </span><span>Some(dsn) = client.</span><span style="color:#96b5b4;">dsn</span><span>() {
</span><span>        sentry_debug!(&quot;</span><span style="color:#a3be8c;">enabled sentry client for DSN {}</span><span>&quot;, dsn);
</span><span>    } </span><span style="color:#b48ead;">else </span><span>{
</span><span>        sentry_debug!(&quot;</span><span style="color:#a3be8c;">initialized disabled sentry client due to disabled or invalid DSN</span><span>&quot;);
</span><span>    }
</span><span>    </span><span style="color:#b48ead;">if</span><span> auto_session_tracking &amp;&amp; session_mode == SessionMode::Application {
</span><span>        </span><span style="color:#b48ead;">crate</span><span>::start_session()
</span><span>    }
</span><span>    ClientInitGuard(client)
</span><span>}
</span></code></pre>
<p><code>sentry::init()</code> ã¯ã¾ãš <a href="https://github.com/getsentry/sentry-rust/blob/0.23.0/sentry/src/defaults.rs#L84-L88"><code>apply_defaults()</code></a> ã§ç’°å¢ƒå¤‰æ•° <code>SENTRY_DSN</code> ã‹ã‚‰ DSN ã‚’å–å¾—ã—ã¾ã™.
ãã‚Œã‚’ç”¨ã„ã¦ <code>Client</code> ã‚’ä½œã‚Š, ã‚«ãƒ¬ãƒ³ãƒˆã‚¹ãƒ¬ãƒƒãƒ‰ã® <code>Hub</code> ã«æ¸¡ã—ã¦ã„ã¾ã™. (c.f. <a href="https://github.com/getsentry/sentry-rust/blob/0.23.0/sentry-core/src/hub.rs#L151"><code>Hub::with()</code></a>)</p>
<p>https://github.com/getsentry/sentry-rust/blob/0.23.0/sentry-core/src/api.rs#L40</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#b48ead;">pub fn </span><span style="color:#8fa1b3;">capture_event</span><span>(</span><span style="color:#bf616a;">event</span><span>: Event&lt;</span><span style="color:#b48ead;">&#39;static</span><span>&gt;) -&gt; Uuid {
</span><span>    Hub::with_active(|</span><span style="color:#bf616a;">hub</span><span>| hub.</span><span style="color:#96b5b4;">capture_event</span><span>(event))
</span><span>}
</span></code></pre>
<p><code>sentry::capture_event()</code> ã¯ã‚«ãƒ¬ãƒ³ãƒˆã‚¹ãƒ¬ãƒƒãƒ‰ã® <code>Hub</code> ã® <a href="https://github.com/getsentry/sentry-rust/blob/0.23.0/sentry-core/src/hub.rs#L276"><code>Hub::capture_event()</code></a> ã‚’å‘¼ã³å‡ºã—ã¾ã™ãŒ,
ã“ã“ã§ <code>Hub</code> ã®ä¸­ã® <code>Client</code> ã® <code>Client::capture_event()</code> ã‚’å‘¼ã³ã¾ã™. (c.f. <a href="https://github.com/getsentry/sentry-rust/blob/0.23.0/sentry-core/src/hub.rs#L173"><code>Hub::with_active()</code></a>)</p>
<p>ã¨ã„ã†ã‚ˆã†ã«, <code>sentry::capture_event()</code> ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‰‹æ”¾ã—ã§å‘¼ã³å‡ºã›ã‚‹ã®ã¯ sentry ãŒè£å´ã§ <strong>ã‚¹ãƒ¬ãƒƒãƒ‰ã«ç´ã¥ã <code>Hub</code></strong> ã‚’çµŒç”±ã—ã¦è‰²ã€…ã‚„ã‚Šãã‚Šã—ã¦ãã‚Œã¦ã„ã‚‹ã‹ã‚‰ã¨ã„ã†ã®ãŒã‚ã‹ã‚Šã¾ã™ã­.</p>
<p>ç‰¹ã« panic ã™ã‚‹ã¨ãã¯æ™®é€šã¯æ˜ç¤ºçš„ã«ä½•ã‹ã‚’æ¸¡ã™ã“ã¨ã¯ã§ãã¾ã›ã‚“ã‹ã‚‰, ã“ã†ã„ã†ä»•çµ„ã¿ã«ãªã£ã¦ã„ã‚‹ã®ã‚‚ç´å¾—ã§ãã¾ã™.</p>
<h2 id="wen-ti-she-ding">å•é¡Œè¨­å®š</h2>
<p>ã•ã¦, ã‚ˆã†ã‚„ãæœ¬é¡Œã§ã™.</p>
<p>Q. ä»¥ä¸‹ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¯æ„å›³ã—ãŸã¨ãŠã‚Šã«å‹•ãã§ã—ã‚‡ã†ã‹?</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span>#[</span><span style="color:#bf616a;">tokio</span><span>::</span><span style="color:#bf616a;">main</span><span>]
</span><span>async </span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">main</span><span>() {
</span><span>    </span><span style="color:#b48ead;">let</span><span> _guard = sentry::init(sentry::ClientOptions::default());
</span><span>
</span><span>    ...do_something... </span><span style="color:#65737e;">// è‰²ã€…å‡¦ç†ã‚’ã™ã‚‹ä¸­ã§ sentry ã‚’å‘¼ã³å‡ºã™.
</span><span>}
</span></code></pre>
<p>ãˆãƒ¼, ã¾ããã‚Šã‚ƒå‹•ãã¾ã™ã‚ˆã­. ãã‚‚ãã‚‚ä½•ãŒå•é¡Œãªã®ã‹ã£ã¦?</p>
<p><a href="https://keno-ss.hatenadiary.org/entry/2019/12/01/235828">ä»¥å‰ã®è¨˜äº‹</a> ã§ã‚‚å°‘ã—è§¦ã‚Œã¾ã—ãŸãŒ, Rust ã®éåŒæœŸã®ä»•çµ„ã¿ã¯</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>- async/await æ§‹æ–‡ã‚’ Future ã«å¤‰æ›.
</span><span>- Future ã¯ asymmetric stackless coroutine. çŠ¶æ…‹æ©Ÿæ¢°ã¨ã—ã¦å®Ÿè£…å¯èƒ½ãªã®ã§ä½ã‚³ã‚¹ãƒˆ.
</span><span>- Future ã¯åˆæˆå¯èƒ½ãªã®ã§ asymmetric stackful coroutine æ¦‚å¿µã‚’ä½œã‚Œã‚‹.
</span><span>- runtime ãŒãã‚Œã‚‰ã‚’ç®¡ç†ã™ã‚‹ã“ã¨ã§ symmetric stackful coroutine ã®ã‚ˆã†ã«è¦‹åšã›ã‚‹.
</span></code></pre>
<p>ã§ã—ãŸ. async fn ã¯ <code>Future</code> ã«ãªã‚Š, ãã‚Œã¯ runtime (ã“ã“ã§ã¯ <code>tokio</code>) ã‹ã‚‰ <code>poll()</code> ã•ã‚Œã¾ã™.
ã¨ã“ã‚ã§ <code>poll()</code> ãŒå‘¼ã³å‡ºã•ã‚Œã‚‹ã¨ãã®ã‚¹ãƒ¬ãƒƒãƒ‰ã£ã¦, ã©ã®ã‚¹ãƒ¬ãƒƒãƒ‰ãŒä½¿ã‚ã‚Œã‚‹ã‚“ã§ã—ãŸã£ã‘?
æ®‹å¿µãªãŒã‚‰ãã‚Œã«å¯¾ã™ã‚‹ã€Œä¿è¨¼ã€ãªã©ã¯ã‚ã‚Šã¾ã›ã‚“.</p>
<p>ã˜ã‚ƒã‚ã‚¹ãƒ¬ãƒƒãƒ‰ã«æƒ…å ±ã‚’ç´ä»˜ã‘ã¦ãªã‚“ã‚„ã‹ã‚“ã‚„ä¸Šæ‰‹ãã‚„ã£ã¦ãã‚Œã‚‹ sentry ã¯å‹•ãã®? ã¨ã„ã†ã®ãŒã“ã®è¨˜äº‹ã®ä¸»é¡Œã§ã™.</p>
<h2 id="huai-sitemiru">å£Šã—ã¦ã¿ã‚‹</h2>
<p>ã•ã¦, ã˜ã‚ƒã‚ä¸€å›å£Šã—ã¦ã¿ã¾ã—ã‚‡ã†ã‹.</p>
<p>Q. ã§ã€Œæ„å›³ã—ãŸã¨ãŠã‚Šã«å‹•ãã®?ã€ã¨æ›¸ãã¾ã—ãŸãŒ, åŸºæœ¬çš„ã«ã¯ sentry ã®å‘¼ã³å‡ºã—è‡ªä½“ã§ã‚¨ãƒ©ãƒ¼ãŒèµ·ããŸã‚Šã¯ã—ã¾ã›ã‚“.
ãŸã , <code>Client</code> ãŒãªã„ãŸã‚ã«ã‚¨ãƒ©ãƒ¼ãŒé€ã‚‰ã‚Œãªã„, ã¨ã„ã†ç¾è±¡ã«ãªã‚Šã¾ã™.
ãã‚Œã‚‚æ„å›³ã—ã¦ãªã„æŒ™å‹•ã§ã¯ã‚ã‚‹ã®ã§, ã“ã“ã§ã¯ã€Œ<code>Hub</code> ã«ã¡ã‚ƒã‚“ã¨ <code>Client</code> ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã®ã‹ã€ã‚’èª¿ã¹ã¦ã¿ã¾ã—ã‚‡ã†.</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span>#[</span><span style="color:#bf616a;">tokio</span><span>::</span><span style="color:#bf616a;">main</span><span>]
</span><span>async </span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">main</span><span>() -&gt; anyhow::Result&lt;()&gt; {
</span><span>    println!(
</span><span>        &quot;</span><span style="color:#a3be8c;">current thread id for `sentry::init()`: </span><span style="color:#d08770;">{:?}</span><span>&quot;,
</span><span>        std::thread::current().</span><span style="color:#96b5b4;">id</span><span>()
</span><span>    );
</span><span>    </span><span style="color:#b48ead;">let</span><span> _guard = sentry::init(sentry::ClientOptions::default());
</span><span>    assert!(Hub::current().</span><span style="color:#96b5b4;">client</span><span>().</span><span style="color:#96b5b4;">is_some</span><span>());
</span><span>    assert!(Hub::main().</span><span style="color:#96b5b4;">client</span><span>().</span><span style="color:#96b5b4;">is_some</span><span>());
</span><span>
</span><span>    </span><span style="color:#b48ead;">let mut</span><span> futs = vec![];
</span><span>    </span><span style="color:#b48ead;">for </span><span>_ in </span><span style="color:#d08770;">0</span><span>..</span><span style="color:#d08770;">10 </span><span>{
</span><span>        futs.</span><span style="color:#96b5b4;">push</span><span>(tokio::task::spawn(async {
</span><span>            println!(&quot;</span><span style="color:#a3be8c;">current thread id: </span><span style="color:#d08770;">{:?}</span><span>&quot;, std::thread::current().</span><span style="color:#96b5b4;">id</span><span>());
</span><span>            assert!(Hub::current().</span><span style="color:#96b5b4;">client</span><span>().</span><span style="color:#96b5b4;">is_some</span><span>());
</span><span>            assert!(Hub::main().</span><span style="color:#96b5b4;">client</span><span>().</span><span style="color:#96b5b4;">is_some</span><span>());
</span><span>        }));
</span><span>    }
</span><span>    futures::future::join_all(futs).await;
</span><span>
</span><span>    println!(&quot;</span><span style="color:#a3be8c;">passed</span><span>&quot;);
</span><span>
</span><span>    Ok(())
</span><span>}
</span></code></pre>
<p>æœ€åˆã« <code>sentry::init()</code> ã‚’å‘¼ã³å‡ºã—ãŸå¾Œ, å„ <code>Future</code> ã®ä¸­ã§ <code>Hub</code> ã® <code>Client</code> ã‚’èª¿ã¹ã¦ã„ã¾ã™.
<code>Hub</code> ãŒ <code>Client</code> ã‚’æŒã£ã¦ã„ãªã‘ã‚Œã° <code>assert!()</code> ã§ panic ã™ã‚‹ã¯ãšã§ã™.</p>
<pre data-lang="console" style="background-color:#2b303b;color:#c0c5ce;" class="language-console "><code class="language-console" data-lang="console"><span>$ SENTRY_DSN=&lt;dsn&gt; cargo run
</span><span>   Compiling example-sentry-init-in-async-main v0.1.0 (/home/keno/src/github.com/kenoss/kenoss.github.io/content/blog/2021-12-02-sentry-init-in-async-main/code/example-sentry-init-in-async-main)
</span><span>    Finished dev [unoptimized + debuginfo] target(s) in 10.43s
</span><span>     Running `target/debug/example-sentry-init-in-async-main`
</span><span>current thread id for `sentry::init()`: ThreadId(1)
</span><span>current thread id: ThreadId(5)
</span><span>current thread id: ThreadId(9)
</span><span>current thread id: ThreadId(5)
</span><span>current thread id: ThreadId(9)
</span><span>current thread id: ThreadId(5)
</span><span>current thread id: ThreadId(9)
</span><span>current thread id: ThreadId(5)
</span><span>current thread id: ThreadId(9)
</span><span>current thread id: ThreadId(5)
</span><span>current thread id: ThreadId(9)
</span><span>passed
</span></code></pre>
<p>ã‚“ãƒ¼, panic ã—ã¾ã›ã‚“ã­?</p>
<p>ã¡ã‚‡ã£ã¨å¼„ã£ã¦ã¿ã¾ã™.</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#b48ead;">use </span><span>sentry::Hub;
</span><span>
</span><span>#[</span><span style="color:#bf616a;">tokio</span><span>::</span><span style="color:#bf616a;">main</span><span>]
</span><span>async </span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">main</span><span>() -&gt; anyhow::Result&lt;()&gt; {
</span><span>    tokio::task::spawn(async {
</span><span>        println!(
</span><span>            &quot;</span><span style="color:#a3be8c;">current thread id for `sentry::init()`: </span><span style="color:#d08770;">{:?}</span><span>&quot;,
</span><span>            std::thread::current().</span><span style="color:#96b5b4;">id</span><span>()
</span><span>        );
</span><span>        </span><span style="color:#b48ead;">let</span><span> _guard = sentry::init(sentry::ClientOptions::default());
</span><span>        assert!(Hub::current().</span><span style="color:#96b5b4;">client</span><span>().</span><span style="color:#96b5b4;">is_some</span><span>());
</span><span>        assert!(Hub::main().</span><span style="color:#96b5b4;">client</span><span>().</span><span style="color:#96b5b4;">is_some</span><span>());
</span><span>
</span><span>        </span><span style="color:#b48ead;">let mut</span><span> futs = vec![];
</span><span>        </span><span style="color:#b48ead;">for </span><span>_ in </span><span style="color:#d08770;">0</span><span>..</span><span style="color:#d08770;">10 </span><span>{
</span><span>            futs.</span><span style="color:#96b5b4;">push</span><span>(tokio::task::spawn(async {
</span><span>                println!(&quot;</span><span style="color:#a3be8c;">current thread id: </span><span style="color:#d08770;">{:?}</span><span>&quot;, std::thread::current().</span><span style="color:#96b5b4;">id</span><span>());
</span><span>                assert!(Hub::current().</span><span style="color:#96b5b4;">client</span><span>().</span><span style="color:#96b5b4;">is_some</span><span>());
</span><span>                assert!(Hub::main().</span><span style="color:#96b5b4;">client</span><span>().</span><span style="color:#96b5b4;">is_some</span><span>());
</span><span>            }));
</span><span>        }
</span><span>        futures::future::join_all(futs).await;
</span><span>
</span><span>        println!(&quot;</span><span style="color:#a3be8c;">passed</span><span>&quot;);
</span><span>    })
</span><span>    .await?;
</span><span>
</span><span>    Ok(())
</span><span>}
</span></code></pre>
<p><code>tokio::task::spawn()</code> ã§ãã‚‹ã‚“ã§ã¿ã¾ã—ãŸ.
ã“ã‚Œã§ <code>sentry::init()</code> ã¯ (ãƒ—ãƒ­ã‚»ã‚¹é–‹å§‹æ™‚ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã¨ã¯é•ã†ã‹ã‚‚ã—ã‚Œãªã„) ãƒ©ãƒ³ãƒ€ãƒ ãªã‚¹ãƒ¬ãƒƒãƒ‰ã§å®Ÿè¡Œã•ã‚Œã‚‹ã“ã¨ã«ãªã‚Šã¾ã™.</p>
<pre data-lang="console" style="background-color:#2b303b;color:#c0c5ce;" class="language-console "><code class="language-console" data-lang="console"><span>$ SENTRY_DSN=&lt;dsn&gt; cargo run
</span><span>    Finished dev [unoptimized + debuginfo] target(s) in 0.63s
</span><span>     Running `target/debug/example-sentry-init-in-async-main`
</span><span>current thread id for `sentry::init()`: ThreadId(9)
</span><span>current thread id: ThreadId(7)
</span><span>current thread id: ThreadId(8)
</span><span>current thread id: ThreadId(3)
</span><span>current thread id: ThreadId(8)
</span><span>current thread id: ThreadId(7)
</span><span>current thread id: ThreadId(9)
</span><span>current thread id: ThreadId(7)
</span><span>current thread id: ThreadId(7)
</span><span>current thread id: ThreadId(8)
</span><span>current thread id: ThreadId(3)
</span><span>passed
</span></code></pre>
<p>ã‚ã‚Œ...? ã“ã‚“ãªã¯ãšã§ã¯...</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#b48ead;">use </span><span>sentry::Hub;
</span><span>
</span><span>#[</span><span style="color:#bf616a;">tokio</span><span>::</span><span style="color:#bf616a;">main</span><span>]
</span><span>async </span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">main</span><span>() -&gt; anyhow::Result&lt;()&gt; {
</span><span>    assert!(Hub::current().</span><span style="color:#96b5b4;">client</span><span>().</span><span style="color:#96b5b4;">is_none</span><span>());
</span><span>    assert!(Hub::main().</span><span style="color:#96b5b4;">client</span><span>().</span><span style="color:#96b5b4;">is_none</span><span>());
</span><span>
</span><span>    tokio::task::spawn(async {
</span><span>        println!(
</span><span>            &quot;</span><span style="color:#a3be8c;">current thread id for `sentry::init()`: </span><span style="color:#d08770;">{:?}</span><span>&quot;,
</span><span>            std::thread::current().</span><span style="color:#96b5b4;">id</span><span>()
</span><span>        );
</span><span>        </span><span style="color:#b48ead;">let</span><span> _guard = sentry::init(sentry::ClientOptions::default());
</span><span>        assert!(Hub::current().</span><span style="color:#96b5b4;">client</span><span>().</span><span style="color:#96b5b4;">is_some</span><span>());
</span><span>        assert!(Hub::main().</span><span style="color:#96b5b4;">client</span><span>().</span><span style="color:#96b5b4;">is_some</span><span>());
</span><span>
</span><span>        </span><span style="color:#b48ead;">let mut</span><span> futs = vec![];
</span><span>        </span><span style="color:#b48ead;">for </span><span>_ in </span><span style="color:#d08770;">0</span><span>..</span><span style="color:#d08770;">10 </span><span>{
</span><span>            futs.</span><span style="color:#96b5b4;">push</span><span>(tokio::task::spawn(async {
</span><span>                println!(&quot;</span><span style="color:#a3be8c;">current thread id: </span><span style="color:#d08770;">{:?}</span><span>&quot;, std::thread::current().</span><span style="color:#96b5b4;">id</span><span>());
</span><span>                assert!(Hub::current().</span><span style="color:#96b5b4;">client</span><span>().</span><span style="color:#96b5b4;">is_some</span><span>());
</span><span>                assert!(Hub::main().</span><span style="color:#96b5b4;">client</span><span>().</span><span style="color:#96b5b4;">is_some</span><span>());
</span><span>            }));
</span><span>        }
</span><span>        futures::future::join_all(futs).await;
</span><span>
</span><span>        println!(&quot;</span><span style="color:#a3be8c;">passed</span><span>&quot;);
</span><span>    })
</span><span>    .await?;
</span><span>
</span><span>    Ok(())
</span><span>}
</span></code></pre>
<p>ã“ã“ã§å¡©ã‚’ã²ã¨ã¤ã¾ã¿.
æœ€åˆã«è¬ã® assert ã‚’å…¥ã‚Œã¦ã¿ã¾ã™.</p>
<pre data-lang="console" style="background-color:#2b303b;color:#c0c5ce;" class="language-console "><code class="language-console" data-lang="console"><span>$  SENTRY_DSN=&lt;dsn&gt; cargo run
</span><span>    Finished dev [unoptimized + debuginfo] target(s) in 6.88s
</span><span>     Running `target/debug/example-sentry-init-in-async-main`
</span><span>current thread id for `sentry::init()`: ThreadId(7)
</span><span>thread &#39;tokio-runtime-worker&#39; panicked at &#39;assertion failed: Hub::main().client().is_some()&#39;, src/main.rs:15:9
</span><span>note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
</span><span>Error: panic
</span></code></pre>
<p>ãŠ!! ä¸Šæ‰‹ãã„ãã¾ã—ãŸã­!!</p>
<p>ã‚„ã£ã¨ <code>sentry::init()</code> ã‚’å‘¼ã‚“ã§ã„ã‚‹ã®ã« <code>Hub</code> ãŒ <code>Client</code> ã‚’æŒã£ã¦ã„ãªã„, ã¨ã„ã†çŠ¶æ³ãŒã§ãã¾ã—ãŸ.</p>
<h2 id="jie-shuo-bian">è§£èª¬ç·¨</h2>
<p>https://github.com/getsentry/sentry-rust/blob/0.23.0/sentry-core/src/hub.rs#L142</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span>    </span><span style="color:#b48ead;">pub fn </span><span style="color:#8fa1b3;">main</span><span>() -&gt; Arc&lt;Hub&gt; {
</span><span>        </span><span style="color:#d08770;">PROCESS_HUB</span><span>.</span><span style="color:#d08770;">0.</span><span style="color:#96b5b4;">clone</span><span>()
</span><span>    }
</span></code></pre>
<p><code>Hub::main()</code> ã¯å˜ã« <code>Hub</code> ã‚’å‚ç…§ã—ã¦ã„ã‚‹ã ã‘ã®ã‚ˆã†ã«è¦‹ãˆã¾ã™. ãªã‚“ã§ <code>Hub::main()</code> ã®å‘¼ã³å‡ºã—ãªã—ã§ã¯ä¸Šæ‰‹ãã„ã, å‘¼ã³å‡ºã—ã‚’è¶³ã™ã¨æ„å›³ã—ãªã„çŠ¶æ³ãŒç™ºç”Ÿã—ãŸã®ã§ã—ã‚‡ã†ã‹?</p>
<p>ã“ã‚Œã‚’ç†è§£ã™ã‚‹ãŸã‚ã«ã¯, <code>Hub</code> ãŒã„ã¤ã©ã®ã‚ˆã†ã«åˆæœŸåŒ–ã•ã‚Œã‚‹ã®ã‹ã‚’çŸ¥ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™.</p>
<p>https://github.com/getsentry/sentry-rust/blob/0.23.0/sentry-core/src/hub.rs#L17-L30</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span>#[</span><span style="color:#bf616a;">cfg</span><span>(feature = &quot;</span><span style="color:#a3be8c;">client</span><span>&quot;)]
</span><span>lazy_static::lazy_static! {
</span><span>    </span><span style="color:#b48ead;">static ref </span><span style="color:#d08770;">PROCESS_HUB</span><span>: (Arc&lt;Hub&gt;, thread::ThreadId) = (
</span><span>        Arc::new(Hub::new(None, Arc::new(Default::default()))),
</span><span>        thread::current().</span><span style="color:#96b5b4;">id</span><span>()
</span><span>    );
</span><span>}
</span><span>
</span><span>#[</span><span style="color:#bf616a;">cfg</span><span>(feature = &quot;</span><span style="color:#a3be8c;">client</span><span>&quot;)]
</span><span>thread_local! {
</span><span>    </span><span style="color:#b48ead;">static </span><span style="color:#d08770;">THREAD_HUB</span><span>: UnsafeCell&lt;Arc&lt;Hub&gt;&gt; = UnsafeCell::new(
</span><span>        Arc::new(Hub::new_from_top(&amp;</span><span style="color:#d08770;">PROCESS_HUB</span><span>.</span><span style="color:#d08770;">0</span><span>)));
</span><span>    </span><span style="color:#b48ead;">static </span><span style="color:#d08770;">USE_PROCESS_HUB</span><span>: Cell&lt;</span><span style="color:#b48ead;">bool</span><span>&gt; = Cell::new(</span><span style="color:#d08770;">PROCESS_HUB</span><span>.</span><span style="color:#d08770;">1 </span><span>== thread::current().</span><span style="color:#96b5b4;">id</span><span>());
</span><span>}
</span></code></pre>
<p><code>hub.rs</code> ã®ä¸­ã§ã¯ãµãŸã¤ã®å¤‰æ•°ãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã™.</p>
<ul>
<li><code>PROCESS_HUB</code>
<ul>
<li>ãƒ—ãƒ­ã‚»ã‚¹å†…ã§ unique ãªã‚„ã¤.</li>
<li><code>sentry::init()</code> ã§ <code>Client</code> ãŒã‚»ãƒƒãƒˆã•ã‚Œã¦ <strong>ã»ã—ã„</strong>.</li>
</ul>
</li>
<li><code>THREAD_HUB</code>
<ul>
<li>ã‚¹ãƒ¬ãƒƒãƒ‰æ¯ã«åˆæœŸåŒ–ã•ã‚Œã‚‹. åˆæœŸåŒ–æ™‚ã« <code>PROCESS_HUB</code> ã‚’å‚ç…§ã—ã¦åˆ©ç”¨ã™ã‚‹.</li>
</ul>
</li>
</ul>
<p>å¯¾å¿œã™ã‚‹ <code>lazy_static!</code> ã¨ <code>thread_local!</code> ã®åˆæœŸåŒ–ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã¯ãã‚Œãã‚Œä»¥ä¸‹ã§ã™.</p>
<ul>
<li><code>lazy_static!</code>
<ul>
<li>æœ€åˆã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã¨ãã«åˆæœŸåŒ–ã•ã‚Œã‚‹.</li>
</ul>
</li>
<li><code>thread_local!</code>
<ul>
<li>https://doc.rust-lang.org/std/thread/struct.LocalKey.html#initialization-and-destruction</li>
<li>æœ€åˆã« <code>with()</code> ãŒå‘¼ã°ã‚ŒãŸã¨ãã«åˆæœŸåŒ–ã•ã‚Œã‚‹.</li>
</ul>
</li>
</ul>
<p>ã¨ã„ã†ã“ã¨ã¯ <code>PROCESS_HUB</code> ã¯æœ€åˆã«ã©ã“ã‹ã® <code>THREAD_HUB</code> ãŒå‚ç…§ã•ã‚ŒãŸã¨ãã«åˆæœŸåŒ–ã•ã‚Œã¾ã™.</p>
<p>ä¸€æ–¹, <code>sentry::init()</code> ã¯ <code>Hub::with</code> ã§åˆæœŸåŒ–å¯¾è±¡ã® <code>Hub</code> ã‚’é¸ã‚“ã§ã„ã¾ã™.</p>
<p>https://github.com/getsentry/sentry-rust/blob/0.23.0/sentry-core/src/hub.rs#L150</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span>    #[</span><span style="color:#bf616a;">cfg</span><span>(feature = &quot;</span><span style="color:#a3be8c;">client</span><span>&quot;)]
</span><span>    </span><span style="color:#b48ead;">pub fn </span><span style="color:#8fa1b3;">with</span><span>&lt;F, R&gt;(</span><span style="color:#bf616a;">f</span><span>: F) -&gt; R
</span><span>    </span><span style="color:#b48ead;">where
</span><span>        F: FnOnce(&amp;Arc&lt;Hub&gt;) -&gt; R,
</span><span>    {
</span><span>        </span><span style="color:#b48ead;">if </span><span style="color:#d08770;">USE_PROCESS_HUB</span><span>.</span><span style="color:#96b5b4;">with</span><span>(Cell::get) {
</span><span>            </span><span style="color:#96b5b4;">f</span><span>(&amp;</span><span style="color:#d08770;">PROCESS_HUB</span><span>.</span><span style="color:#d08770;">0</span><span>)
</span><span>        } </span><span style="color:#b48ead;">else </span><span>{
</span><span>            </span><span style="color:#65737e;">// note on safety: this is safe because even though we change the Arc
</span><span>            </span><span style="color:#65737e;">// by temporary binding we guarantee that the original Arc stays alive.
</span><span>            </span><span style="color:#65737e;">// For more information see: run
</span><span>            </span><span style="color:#d08770;">THREAD_HUB</span><span>.</span><span style="color:#96b5b4;">with</span><span>(|</span><span style="color:#bf616a;">stack</span><span>| </span><span style="color:#b48ead;">unsafe </span><span>{
</span><span>                </span><span style="color:#b48ead;">let</span><span> ptr = stack.</span><span style="color:#96b5b4;">get</span><span>();
</span><span>                </span><span style="color:#96b5b4;">f</span><span>(&amp;*ptr)
</span><span>            })
</span><span>        }
</span><span>    }
</span></code></pre>
<p><code>Hub::with()</code> ã¯ã‚«ãƒ¬ãƒ³ãƒˆã‚¹ãƒ¬ãƒƒãƒ‰ãŒ <code>PROCESS_HUB</code> ã‚’åˆæœŸåŒ–ã—ãŸã‚¹ãƒ¬ãƒƒãƒ‰ãªã‚‰ãã‚Œã‚’ä½¿ã„, ãã†ã§ãªã‘ã‚Œã° <code>THREAD_HUB</code> ã‚’ä½¿ã„ã¾ã™.</p>
<p>ãªã®ã§, å£Šã—ã¦ã¿ã‚‹ã®ã¨ã“ã‚ã§ä½•ãŒèµ·ã“ã£ã¦ã„ãŸã‹ã¨ã„ã†ã¨,</p>
<ul>
<li><code>sentry::init()</code> ã®å‘¼ã³å‡ºã—å‰ã«ä½•ã‚‚ãªã‘ã‚Œã°, <code>PROCESS_HUB</code> ã« <code>Client</code> ãŒã‚»ãƒƒãƒˆã•ã‚Œ, ä»–ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã§ã¯ <code>Hub::with()</code> ãªã©ã§ <code>Hub</code> ã‚’ä½¿ãŠã†ã¨ã—ãŸç¬é–“ã« <code>PROCESS_HUB</code> ã‚’å‚ç…§ã—ã¦ <code>Client</code> ã‚’è¨­å®šã™ã‚‹.</li>
<li><code>sentry::init()</code> ã®å‘¼ã³å‡ºã—å‰ã« <code>Hub::main()</code> ãªã©ã®å‘¼ã³å‡ºã—ãŒã‚ã‚‹ã¨, ãã®ã‚¹ãƒ¬ãƒƒãƒ‰ã§ <code>PROCESS_HUB</code> ãŒåˆæœŸåŒ–ã•ã‚Œã‚‹. ä»–ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã§ <code>sentry::init()</code> ã™ã‚‹ã¨ãã®ã‚¹ãƒ¬ãƒƒãƒ‰ã® <code>THREAD_HUB</code> ã« <code>Client</code> ãŒã‚»ãƒƒãƒˆã•ã‚Œã‚‹. ãã®ä»–ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã§ã¯ <code>THREAD_HUB</code> ã« <code>Client</code> ã¯ã„ãªã„.</li>
</ul>
<p>ã¨ãªã£ã¦ã„ãŸã®ã§ã—ãŸ. ãªã‚‹ã»ã©ãªã.</p>
<h2 id="jie-da-bian">è§£ç­”ç·¨</h2>
<p>å…ƒã®ç–‘å•</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>Q. ä»¥ä¸‹ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¯æ„å›³ã—ãŸã¨ãŠã‚Šã«å‹•ãã§ã—ã‚‡ã†ã‹?
</span></code></pre>
<p>ã«æˆ»ã‚‹ã¨, ç­”ãˆã¯</p>
<p>A. async main() ã®å…ˆé ­ã§ <code>sentry::init()</code> ã‚’å‘¼ã³å‡ºã—ã¦ã„ã‚‹é™ã‚Šã¯ <code>Client</code> ã¯ã‚»ãƒƒãƒˆã•ã‚Œã‚‹.</p>
<p>ã¨ã„ã†ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸ.</p>
<p>ãµã…, ã“ã‚Œã§ã‚„ã£ã¨å®‰å¿ƒã—ã¦ production ã®ã‚µãƒ¼ãƒãƒ¼ã« sentry ã‚’å…¥ã‚Œã‚‰ã‚Œã¾ã™ã­.</p>
<p>ãŸã , ã“ã“ã§ã¯ <code>Client</code> ãŒæ„å›³é€šã‚Šã«ã‚»ãƒƒãƒˆã•ã‚Œã‚‹ã®ã‹ã©ã†ã‹ã—ã‹è¦‹ã¦ã„ã¾ã›ã‚“.
ä¾‹ãˆã° <a href="https://docs.rs/sentry/0.23.0/sentry/struct.Hub.html#method.add_breadcrumb">breadcrumb</a> ã®ã‚ˆã†ãªã‚‚ã®ã¯ã‚¹ãƒ¬ãƒƒãƒ‰ã«ç´ä»˜ãã¾ã™.
ã‚¹ãƒ¬ãƒƒãƒ‰ã«ç´ã¥ãã‚‚ã®ã¯ async ä¸‹ã§ã¯åŸºæœ¬çš„ã«ã¯ä¸Šæ‰‹ãå‹•ã‹ãªã„ã§ã™.</p>
<p>ã˜ã‚ƒã‚ãã†ã„ã†ã€Œæ–‡è„ˆæƒ…å ±ã€ã¾ã§å–å¾—ã—ãŸã„ã¨ãªã£ãŸã‚‰ã©ã†ã™ã‚Œã°ã„ã„ã®ã‹ã¨ã„ã†ã¨, ãã‚Œã¯ <a href="https://github.com/tokio-rs/tracing"><code>tracing</code> crate</a> ã®è©±ã«ãªã‚‹ã®ã§, ã¾ãŸæ°—ãŒå‘ã„ãŸã‚‰ãã‚Œã«ã¤ã„ã¦æ›¸ãã‹ã‚‚ã—ã‚Œã¾ã›ã‚“.</p>

    </div>
</article>

            </main>
            <footer>
                <div class="footer">
                    <small class="footer-left">
                        Â© 2021--2024. All rights reserved.
                    </small>
                    <small class="footer-right">
                        Powered by <a href="https://www.getzola.org">Zola</a>
                    </small>
                </div>
            </footer>
        </div>
    </body>
</html>
