<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title>
ä¸€æ­©è¸ã¿è¾¼ã‚“ã  tracing ã®è¨­å®š (Rust) | å†·ãŸãæ²¢ã®å²©é™°ã®
</title>

        
<meta property="og:image" content="https:&#x2F;&#x2F;kenoss.github.io&#x2F;ogp.jpg" />
<meta property="og:title" content="ä¸€æ­©è¸ã¿è¾¼ã‚“ã  tracing ã®è¨­å®š (Rust)" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https:&#x2F;&#x2F;kenoss.github.io&#x2F;blog&#x2F;2025-12-13-advanced-tracing-config&#x2F;" />

<meta property="og:site_name" content="å†·ãŸãæ²¢ã®å²©é™°ã®" />

<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@keno_ss" />


        



        <link rel="stylesheet" href="https://kenoss.github.io/theme.css">
    </head>
    <body>
        <div class="content">
            <header>
                <div class="header-left">
                    <a href="https:&#x2F;&#x2F;kenoss.github.io" class="header-logo">å†·ãŸãæ²¢ã®å²©é™°ã®</a>
                </div>
                <div class="header-right">
                </div>
            </header>
            <main>
                
<article itemscope itemtype="http://schema.org/BlogPosting">
    <div class="headline" itemprop="headline">
        <h1 class="post-title">ä¸€æ­©è¸ã¿è¾¼ã‚“ã  tracing ã®è¨­å®š (Rust)</h2>
        <div class="border"></div>
        <div>
            <time datetime="2025-12-13" class="post-date" itemprop="datePublished">
                2025-12-13
            </time>
            
                |
                
                    <span class="post-tag">ğŸ¦€ rust</span>
                
                    <span class="post-tag">ğŸ¦€ tech</span>
                
                    <span class="post-tag">ğŸ¦€ tracing</span>
                
                        
        </div>
    </div>
    <div itemprop="articleBody">
        <p>ã“ã‚Œã¯ <a href="https://qiita.com/advent-calendar/2025/rust">Rust Advent Calendar 2025</a> 13æ—¥ç›®ã®è¨˜äº‹ã§ã™ <sup class="footnote-reference"><a href="#1">1</a></sup>.</p>
<h2 id="intro">Intro</h2>
<p>ã¿ãªã•ã‚“ tracing ã—ã¦ã¾ã™ã‹? ã—ã¦ã¾ã™ã‚ˆã­. ç§ã¯ã»ã¼å¸¸ã«ã—ã¦ã„ã¾ã™.</p>
<p>Rust ã§ã® <a href="https://docs.rs/tracing/latest/tracing/"><code>tracing</code></a> ã¯, ã–ã£ãã‚Šè¨€ã†ã¨</p>
<ul>
<li>(<a href="https://docs.rs/tracing/latest/tracing/"><code>tracing</code></a>; ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚„ã‚¢ãƒ—ãƒªå´ã§)
log ã‚„ span ã‚’ä»•è¾¼ã‚“ã§ãŠã,</li>
<li>(<a href="https://docs.rs/tracing-subscriber/latest/tracing_subscriber/"><code>tracing_subscriber</code></a>; ã‚¢ãƒ—ãƒªå´ã§)
ãã‚Œã‚‰ã‚’è¡¨ç¤ºã—ãŸã‚Šã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’èµ·ã“ã™.</li>
</ul>
<p>ä»•çµ„ã¿ã§ã™.</p>
<p>ã“ã®è¨˜äº‹ã§ã¯åŸºæœ¬çš„ãªæ¦‚å¿µ, ã©ã†ã‚„ã£ãŸã‚‰ä½¿ãˆã‚‹ã®ã‹, å†…éƒ¨ã®ä»•çµ„ã¿ã«ã¤ã„ã¦ã¯è§£èª¬ã›ãš, ä»®å®šã—ã¾ã™. ä»¥ä¸‹ã®è¨˜äº‹ãŒãŠã™ã™ã‚ã§ã™:</p>
<ul>
<li>ãã‚‚ãã‚‚ tracing ã£ã¦ä½•? ã©ã†ã‚„ã£ãŸã‚‰ä½¿ãˆã‚‹ã®?
<ul>
<li>å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
<a href="https://docs.rs/tracing/latest/tracing/"><code>tracing</code></a>,
<a href="https://docs.rs/tracing-subscriber/latest/tracing_subscriber/"><code>tracing_subscriber</code></a></li>
<li><a href="https://techblog.paild.co.jp/entry/2024/04/02/144212">Rustã§ã‚ªãƒ–ã‚¶ãƒ¼ãƒãƒ“ãƒªãƒ†ã‚£ã‚’å®Ÿç¾ã™ã‚‹ã«ã¯ (@ymgyt)</a></li>
</ul>
</li>
<li>å†…éƒ¨ã®ä»•çµ„ã¿
<ul>
<li><a href="https://blog.ymgyt.io/entry/how-tracing-and-tracing-subscriber-write-events/">tracing/tracing-subscriberã§ãƒ­ã‚°ãŒå‡ºåŠ›ã•ã‚Œã‚‹ä»•çµ„ã¿ã‚’ç†è§£ã™ã‚‹ (@helloyuki)</a></li>
</ul>
</li>
<li>otel ã§ä½¿ã£ã¦ã¿ãŸã„
<ul>
<li><a href="https://blog.ojisan.io/rust-tracing/">Rust ã§ã® tracing (@sadnessOjisan)</a></li>
</ul>
</li>
</ul>
<p>ã•ã¦, <code>tracing</code> crate ã®ä½¿ã„æ–¹ã¨ã—ã¦æœ€ã‚‚ã‚ˆãã‚ã‚‹ã®ã¯
<a href="https://docs.rs/log/latest/log/"><code>log</code></a>/<a href="https://docs.rs/env_logger/latest/env_logger/"><code>env_logger</code></a> crate
çš„ãªæŒ™å‹•ã®ãŸã‚ã«ä»¥ä¸‹ã®æ§˜ãªè¨­å®šã‚’ä½¿ã†ã‚„ã¤ã§ã—ã‚‡ã†:</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span>#[</span><span style="color:#bf616a;">allow</span><span>(unused_imports)]
</span><span>#[</span><span style="color:#bf616a;">macro_use</span><span>]
</span><span style="color:#b48ead;">extern crate</span><span> tracing;
</span><span>
</span><span style="color:#b48ead;">use</span><span> anyhow;
</span><span>
</span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">tracing_init</span><span>() {
</span><span>    </span><span style="color:#b48ead;">use </span><span>time::UtcOffset;
</span><span>    </span><span style="color:#b48ead;">use </span><span>time::macros::format_description;
</span><span>    </span><span style="color:#b48ead;">use </span><span>tracing_subscriber::EnvFilter;
</span><span>    </span><span style="color:#b48ead;">use </span><span>tracing_subscriber::fmt::time::OffsetTime;
</span><span>
</span><span>    </span><span style="color:#b48ead;">let</span><span> offset = UtcOffset::current_local_offset().</span><span style="color:#96b5b4;">unwrap</span><span>();
</span><span>    </span><span style="color:#b48ead;">let</span><span> timer = OffsetTime::new(
</span><span>        offset,
</span><span>        format_description!(&quot;</span><span style="color:#a3be8c;">[hour]:[minute]:[second].[subsecond digits:3]</span><span>&quot;),
</span><span>    );
</span><span>
</span><span>    tracing_subscriber::fmt()
</span><span>        </span><span style="color:#65737e;">// `RUST_LOG` ç’°å¢ƒå¤‰æ•°ã«å¿œã˜ã¦ãƒ­ã‚°ã‚’å‡ºåŠ›ã™ã‚‹ã‹ã©ã†ã‹ã‚’åˆ¶å¾¡
</span><span>        .</span><span style="color:#96b5b4;">with_env_filter</span><span>(EnvFilter::from_default_env())
</span><span>        </span><span style="color:#65737e;">// æ™‚åˆ»ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå¤‰æ›´
</span><span>        .</span><span style="color:#96b5b4;">with_timer</span><span>(timer)
</span><span>        </span><span style="color:#65737e;">// trace ã®ãƒ•ã‚¡ã‚¤ãƒ«ä¸­ã®è¡Œæ•°ã‚’è¡¨ç¤º
</span><span>        .</span><span style="color:#96b5b4;">with_line_number</span><span>(</span><span style="color:#d08770;">true</span><span>)
</span><span>        </span><span style="color:#65737e;">// è‰²ã‚’ä»˜ã‘ã‚‹
</span><span>        .</span><span style="color:#96b5b4;">with_ansi</span><span>(</span><span style="color:#d08770;">true</span><span>)
</span><span>        .</span><span style="color:#96b5b4;">init</span><span>();
</span><span>}
</span><span>
</span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">main</span><span>() -&gt; anyhow::Result&lt;()&gt; {
</span><span>    </span><span style="color:#96b5b4;">tracing_init</span><span>();
</span><span>
</span><span>    </span><span style="color:#96b5b4;">hoge</span><span>()?;
</span><span>
</span><span>    Ok(())
</span><span>}
</span><span>
</span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">hoge</span><span>() -&gt; anyhow::Result&lt;()&gt; {
</span><span>    info!(&quot;</span><span style="color:#a3be8c;">log in hoge</span><span>&quot;);
</span><span>
</span><span>    </span><span style="color:#96b5b4;">f</span><span>(</span><span style="color:#d08770;">2</span><span>);
</span><span>
</span><span>    Ok(())
</span><span>}
</span><span>
</span><span>#[</span><span style="color:#bf616a;">tracing</span><span>::</span><span style="color:#bf616a;">instrument</span><span>]
</span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">f</span><span>(</span><span style="color:#bf616a;">n</span><span>: </span><span style="color:#b48ead;">usize</span><span>) {
</span><span>    debug!(&quot;</span><span style="color:#a3be8c;">f({n})</span><span>&quot;);
</span><span>
</span><span>    </span><span style="color:#b48ead;">if</span><span> n == </span><span style="color:#d08770;">0 </span><span>{
</span><span>        </span><span style="color:#b48ead;">return</span><span>;
</span><span>    }
</span><span>
</span><span>    </span><span style="color:#96b5b4;">f</span><span>(n - </span><span style="color:#d08770;">1</span><span>);
</span><span>}
</span></code></pre>
<p>å‡ºåŠ›ã‚µãƒ³ãƒ—ãƒ«ã¯ã“ã‚“ãªæ„Ÿã˜ã§ã™:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>$ RUST_LOG=debug cargo run
</span><span>   Compiling hoge v0.1.0 (/home/kenoss/work/hoge)
</span><span>    Finished `dev` profile [unoptimized + debuginfo] target(s) in 0.45s
</span><span>     Running `target/debug/hoge`
</span><span>23:33:39.858  INFO hoge: 40: log in hoge
</span><span>23:33:39.858 DEBUG f{n=2}: hoge: 49: f(2)
</span><span>23:33:39.858 DEBUG f{n=2}:f{n=1}: hoge: 49: f(1)
</span><span>23:33:39.858 DEBUG f{n=2}:f{n=1}:f{n=0}: hoge: 49: f(0)
</span></code></pre>
<p>ã“ã®è¨˜äº‹ã§ã¯ã“ã“ã‹ã‚‰ä¸€æ­©é€²ã‚“ã§, ä»¥ä¸‹ã®æ©Ÿèƒ½ã‚’è¶³ã—ã¦ã„ãã¾ã™:</p>
<ul>
<li>stdout ã¨ãƒ•ã‚¡ã‚¤ãƒ«ã®ç‰‡æ–¹, ã‚ã‚‹ã„ã¯ä¸¡æ–¹ã«å‡ºåŠ›ã™ã‚‹.</li>
<li>log ã« span context ã‚’è¡¨ç¤ºã—ãªã„.</li>
<li><a href="https://perfetto.dev/">Perfetto</a>/<a href="https://ui.perfetto.dev/">Perfetto UI</a>
ã§èª­ã‚ã‚‹ trace ã‚’è¨˜éŒ²ã™ã‚‹.</li>
<li>ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚’å‹•çš„ã« on/off ã™ã‚‹.</li>
</ul>
<p>åˆæ‰‹ã‹ã‚‰ã‚¢ãƒ¬ãªã‚“ã§ã™ãŒ, é€†ã«è¨€ã†ã¨ã“ã†ã„ã† â€ å¤‰ãªã“ã¨â€  ã‚’ã™ã‚‹å¿…è¦ãŒãªã„å ´åˆã¯ã“ã®è¨˜äº‹ã‚’èª­ã‚€å¿…è¦ã¯ãªã„ã§ã™.
å¿…è¦ã«ãªã£ã¦ã‹ã‚‰èª­ã‚ã°ã‚ˆã„ã§ã™.</p>
<h2 id="versions">Versions</h2>
<ul>
<li><code>tracing</code>/<code>tracing_subscriber</code>: tag <a href="https://github.com/tokio-rs/tracing/tree/tracing-0.1.43"><code>tracing-0.1.43</code></a></li>
<li>sabiniwm: commit <a href="https://github.com/kenoss/sabiniwm/tree/37b905f">37b905f</a></li>
</ul>
<h2 id="tracing-subscriber-fmt-woniu-jie-ku"><code>tracing_subscriber::fmt()</code> ã‚’ç´è§£ã</h2>
<p><code>tracing</code>/<code>tracing_subscriber</code> ã¯åŸºæœ¬çš„ã« simple ãªæ¦‚å¿µã®ç©ã¿é‡ã­ã§ä½œã‚‰ã‚Œã¦ã„ã¾ã™. ã—ã‹ã—
<code>tracing_subscriber::fmt()</code> ã¯é•ã„ã¾ã™. ã“ã„ã¤ã¯ã‚ˆãã‚ã‚‹ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã«ç‰¹åŒ–ã—ãŸ simple ãª
ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã§ã™. ãã®ç¯„å›²ã«åã¾ã£ã¦ã„ã‚Œã°çŸ­ã‹ãæ›¸ã‘ã¦ä¾¿åˆ©ãªã®ã§ã™ãŒ,
ä¸€æ­©è¸ã¿è¾¼ã‚‚ã†ã¨ã—ãŸã¨ãã«ã¯é‚ªé­” <sup class="footnote-reference"><a href="#2">2</a></sup> ã§ã‚‚ã‚ã‚Šã¾ã™.</p>
<p>ã¨ã„ã†ã‚ã‘ã§, ã¾ãšã¯ã“ã‚Œã‚’ <code>tracing_subscriber</code> ã®åŸºæœ¬æ¦‚å¿µã§ã‚ã‚‹
<a href="https://docs.rs/tracing-subscriber/0.3.22/tracing_subscriber/registry/struct.Registry.html"><code>Registry</code></a>
<a href="https://docs.rs/tracing-core/0.1.35/tracing_core/subscriber/trait.Subscriber.html"><code>Subscriber</code></a>,
<a href="https://docs.rs/tracing-subscriber/0.3.22/tracing_subscriber/layer/trait.Layer.html"><code>Layer</code></a>,
<a href="https://docs.rs/tracing-subscriber/0.3.22/tracing_subscriber/layer/trait.Filter.html"><code>Filter</code></a>
ã§æ›¸ãç›´ã—ã¾ã—ã‚‡ã†.</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span>tracing_subscriber::fmt().</span><span style="color:#96b5b4;">init</span><span>();
</span></code></pre>
<p>æœ€å°ã®è¨­å®šã¯ã“ã‚Œã§ã™ãŒ, ã“ã‚Œã¯æ¬¡ã¨ç­‰ä¾¡ã§ã™
[<a href="https://github.com/tokio-rs/tracing/blob/64e1c8d3ae5cf5deab40ad3d376c8595d4e4db7f/tracing-subscriber/src/fmt/mod.rs#L486-L491">cs</a>].</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#b48ead;">let</span><span> subscriber = Registry::default()
</span><span>    .</span><span style="color:#96b5b4;">with</span><span>(fmt::Layer::default());
</span><span>subscriber.</span><span style="color:#96b5b4;">init</span><span>();
</span></code></pre>
<p><code>EnvFilter</code> ã‚’è¶³ã™ã¨</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#b48ead;">let</span><span> subscriber = Registry::default()
</span><span>    .</span><span style="color:#96b5b4;">with</span><span>(EnvFilter::from_default_env())
</span><span>    .</span><span style="color:#96b5b4;">with</span><span>(fmt::Layer::default());
</span><span>subscriber.</span><span style="color:#96b5b4;">init</span><span>();
</span></code></pre>
<p>ã«ãªã‚Šã¾ã™. (<code>with_line_number()</code> ãªã©ã¯æš«ãç„¡è¦–ã—ã¾ã™.)</p>
<p>ã•ã¦, ã“ã‚Œã¯ä½•ã‚’ã‚„ã£ã¦ã„ã‚‹ã®ã§ã—ã‚‡ã†ã‹?</p>
<p>ä¸‹ã‹ã‚‰é€†é †ã«è¦‹ã¦ã„ãã¨, <code>subscriber.init()</code> ã¯
<a href="https://docs.rs/tracing-subscriber/0.3.22/tracing_subscriber/util/trait.SubscriberInitExt.html#method.init"><code>SubscriberInitExt::init()</code></a>
ã§ã‚ã‚Š, ã“ã‚Œã¯ trait <code>Subscriber</code> ã‚’ global ã« set ã—ã¾ã™. å¤‰æ•° <code>subscriber</code> ã®å‹ã¯ (<code>tracing_subscriber::</code> ã¯çœç•¥ã—ã¦)</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>layer::Layered&lt;fmt_layer::Layer&lt;???, N, E, W&gt;,
</span><span>               layer::Layered&lt;EnvFilter,
</span><span>                              Registry
</span><span>                              &gt;
</span><span>               &gt;
</span></code></pre>
<p>ã§ã™. <a href="https://docs.rs/tracing-subscriber/0.3.22/tracing_subscriber/layer/struct.Layered.html"><code>Layered</code></a>
<code>layer::Layered&lt;L, I, S = I&gt;</code> ã¯ <code>L: Layer</code> ã¨ <code>S: Subscriber</code> ã‚’å–ã£ã¦ <code>Subscriber</code> ã‚’è¿”ã™æ§˜ãªã‚‚ã®ã§ã™.
ãã®æ ¸ã«ãªã£ã¦ã„ã‚‹ã®ã¯ <code>Registry</code> ã§, ã“ã‚Œã¯ <code>Subscriber</code> ã‚’ impl ã—ã¦ã„ã¾ã™.</p>
<p><code>Registry</code> ã‚’ä½¿ã†ç†ç”±ã¯ log ã¨ span ã¯ã¡ã‚‡ã£ã¨ç•°ãªã‚Š span ã®æƒ…å ±ã‚’ç”Ÿå­˜æœŸé–“ä¸­ä¿æŒã—ã¦ãŠããŸã‚...ã§ã™ãŒ,
ã¾ãã‚ã‚“ã¾ã‚Šæ·±ãè€ƒãˆãšã«å–ã‚Šæ•¢ãˆãš <code>Registry</code> ã‚’ä½¿ã†ã¨æ€ã£ã¦ãŠã‘ã°ã‚ˆã„ã§ã™.
<code>EnvFilter</code> ã¯ãã“ã‹ã‚‰é™ã‚Šã¦ãã‚‹ log/span ã‚’ <code>RUST_LOG</code> ç’°å¢ƒå¤‰æ•°ã«å¾“ã£ã¦ filtering ã—ã¾ã™ <sup class="footnote-reference"><a href="#3">3</a></sup>.
<code>fmt_layer::Layer</code> ã¯ãã‚Œã‚‰ã‚’æ–‡å­—åˆ—åŒ–ã—, stdout ã«æ›¸ãå‡ºã—ã¾ã™.</p>
<p>ã¨ã„ã†ã‚ã‘ã§, ã“ã‚Œã§ <code>tracing_subscriber::fmt().init()</code> ã‚’ãƒãƒ©ã›ã¾ã—ãŸ.</p>
<h2 id="per-layer-filtering">Per-layer filtering</h2>
<p>ã•ã¦, ã“ã“ã§ log ã‚„ span ã‚’ <strong>å…¨ã¦</strong> è¨˜éŒ²ã—ãŸã„ã¨ãªã£ãŸã¨ãã¯ã©ã†ã™ã‚Œã°ã„ã„ã®ã§ã—ã‚‡ã†?</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#b48ead;">let</span><span> subscriber = Registry::default()
</span><span>    .</span><span style="color:#96b5b4;">with</span><span>(ã“ã“ã§ log and/or span ã‚’è¨˜éŒ²ã™ã‚‹ä½•ã‹)
</span><span>    .</span><span style="color:#96b5b4;">with</span><span>(EnvFilter::from_default_env())
</span><span>    .</span><span style="color:#96b5b4;">with</span><span>(fmt::Layer::default());
</span><span>subscriber.</span><span style="color:#96b5b4;">init</span><span>();
</span></code></pre>
<p>filter ã®å‰ã«ç½®ã„ã¦ã„ã‚‹ã‹ã‚‰ filtering ã¯ã•ã‚Œãšã«å…¨ã¦è¨˜éŒ²ã§ãã‚‹ã§ã—ã‚‡ã†ã‹?
æ®‹å¿µãªãŒã‚‰ã“ã‚Œã¯ <code>EnvFilter</code> ã®å½±éŸ¿ã‚’å—ã‘ã¾ã™ <sup class="footnote-reference"><a href="#4">4</a></sup>. (ä½•æ•…ã‹?ã¨ã„ã†è©±ã¯æ§ãˆã¾ã™ <sup class="footnote-reference"><a href="#5">5</a></sup>.)</p>
<p>ãã“ã§ä½¿ã‚ã‚Œã‚‹ã®ãŒ
<a href="https://docs.rs/tracing-subscriber/0.3.22/tracing_subscriber/layer/index.html#per-layer-filtering">Per-Layer Filtering</a>
ã§ã™. åå‰ã®é€šã‚Š, layer æ¯ã« filtering ã‚’å€‹åˆ¥ã«æŒãŸã›ã¾ã™:</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#b48ead;">let</span><span> subscriber = Registry::default()
</span><span>    .</span><span style="color:#96b5b4;">with</span><span>(ã“ã“ã§ log and/or span ã‚’è¨˜éŒ²ã™ã‚‹ä½•ã‹)
</span><span>    .</span><span style="color:#96b5b4;">with</span><span>(fmt::Layer::default()
</span><span>              .</span><span style="color:#96b5b4;">with_filter</span><span>(EnvFilter::from_default_env()));
</span><span>subscriber.</span><span style="color:#96b5b4;">init</span><span>();
</span></code></pre>
<p><strong><code>tracing_subscriber::fmt().&lt;...&gt;.init()</code> ã§æ¸ˆã¾ãªã„ã¨ãã¯ per-layer filtering ã‚’ä½¿ã†.</strong>
ä»Šæ—¥ã¯ã“ã‚Œã ã‘è¦šãˆã¦å¸°ã£ã¦ãã ã•ã„.</p>
<p>ä»¥é™ã¯å…¨ã¦ã“ã‚Œã‚’ä½¿ã£ãŸå…·ä½“ä¾‹ã«ãªã‚Šã¾ã™.</p>
<h2 id="stdout-and-or-file-nishu-ku">stdout and/or file ã«æ›¸ã</h2>
<p>ãƒ—ãƒ­ã‚°ãƒ©ãƒ é–‹å§‹æ™‚ç‚¹ã§ã®æ¡ä»¶ã«ã‚ˆã£ã¦ä»¥ä¸‹ã‚’åˆ‡ã‚Šæ›¿ãˆãŸã‚Šã—ãŸã„ã§ã™ <sup class="footnote-reference"><a href="#6">6</a></sup>.</p>
<ul>
<li>stdout ã«ã®ã¿å‡ºåŠ›ã™ã‚‹.</li>
<li>ãƒ•ã‚¡ã‚¤ãƒ«ã«å‡ºåŠ›ã™ã‚‹.</li>
<li>stdout ã¨ãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸¡æ–¹ã«å‡ºåŠ›ã™ã‚‹.</li>
</ul>
<p>ã“ã‚Œã¯ä»¥ä¸‹ã®æ§˜ã«ã™ã‚Œã°ã‚ˆã„ã§ã™.</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">tracing_init</span><span>() -&gt; anyhow::Result&lt;()&gt; {
</span><span>    </span><span style="color:#96b5b4;">macro_rules! </span><span>fmt_layer {
</span><span>        () =&gt; {{
</span><span>            </span><span style="color:#b48ead;">let</span><span> offset = UtcOffset::current_local_offset().</span><span style="color:#96b5b4;">unwrap</span><span>();
</span><span>            </span><span style="color:#b48ead;">let</span><span> timer = OffsetTime::new(
</span><span>                offset,
</span><span>                format_description!(&quot;</span><span style="color:#a3be8c;">[hour]:[minute]:[second].[subsecond digits:3]</span><span>&quot;),
</span><span>            );
</span><span>
</span><span>            tracing_subscriber::fmt::Layer::default()
</span><span>                .</span><span style="color:#96b5b4;">compact</span><span>()
</span><span>                .</span><span style="color:#96b5b4;">with_span_events</span><span>(tracing_subscriber::fmt::format::FmtSpan::</span><span style="color:#d08770;">NONE</span><span>)
</span><span>                .</span><span style="color:#96b5b4;">with_ansi</span><span>(</span><span style="color:#d08770;">true</span><span>)
</span><span>                .</span><span style="color:#96b5b4;">with_timer</span><span>(timer)
</span><span>                .</span><span style="color:#96b5b4;">with_level</span><span>(</span><span style="color:#d08770;">true</span><span>)
</span><span>                .</span><span style="color:#96b5b4;">with_target</span><span>(</span><span style="color:#d08770;">true</span><span>)
</span><span>                .</span><span style="color:#96b5b4;">with_file</span><span>(</span><span style="color:#d08770;">false</span><span>)
</span><span>                .</span><span style="color:#96b5b4;">with_line_number</span><span>(</span><span style="color:#d08770;">true</span><span>)
</span><span>        }};
</span><span>    }
</span><span>    </span><span style="color:#b48ead;">let </span><span>(stdout_logging, file_logging) = </span><span style="color:#b48ead;">if </span><span style="color:#96b5b4;">use_file_for_logging</span><span>() {
</span><span>        </span><span style="color:#b48ead;">const </span><span style="color:#d08770;">LOG_FILE</span><span>: &amp;</span><span style="color:#b48ead;">str </span><span>= &quot;</span><span style="color:#a3be8c;">/tmp/hoge.log</span><span>&quot;;
</span><span>        </span><span style="color:#b48ead;">let</span><span> log_file = std::io::LineWriter::new(std::fs::File::create(</span><span style="color:#d08770;">LOG_FILE</span><span>)?);
</span><span>        </span><span style="color:#b48ead;">let</span><span> writer = std::sync::Mutex::new(log_file);
</span><span>        </span><span style="color:#b48ead;">let</span><span> file_logging = fmt_layer!().</span><span style="color:#96b5b4;">with_writer</span><span>(writer);
</span><span>        (None, Some(file_logging))
</span><span>    } </span><span style="color:#b48ead;">else </span><span>{
</span><span>        </span><span style="color:#b48ead;">let</span><span> stdout_logging = fmt_layer!().</span><span style="color:#96b5b4;">with_writer</span><span>(std::io::stdout);
</span><span>        (Some(stdout_logging), None)
</span><span>    };
</span><span>    </span><span style="color:#b48ead;">let</span><span> env_filter = EnvFilter::from_default_env();
</span><span>
</span><span>    </span><span style="color:#b48ead;">let</span><span> subscriber = Registry::default()
</span><span>        .</span><span style="color:#96b5b4;">with</span><span>(
</span><span>            stdout_logging
</span><span>                .</span><span style="color:#96b5b4;">with_filter</span><span>(env_filter.</span><span style="color:#96b5b4;">clone</span><span>()),
</span><span>        )
</span><span>        .</span><span style="color:#96b5b4;">with</span><span>(
</span><span>            file_logging.</span><span style="color:#96b5b4;">with_filter</span><span>(env_filter),
</span><span>        );
</span><span>    subscriber.</span><span style="color:#96b5b4;">init</span><span>();
</span><span>
</span><span>    Ok(())
</span><span>}
</span></code></pre>
<p>è§£èª¬. ã“ã‚Œã¯
<a href="https://docs.rs/tracing-subscriber/0.3.22/tracing_subscriber/layer/trait.Layer.html#impl-Layer%3CS%3E-for-Option%3CL%3E"><code>L: Layer&lt;S&gt;</code> ã®ã¨ã <code>Option&lt;L&gt;: Layer&lt;S&gt;</code></a>
ã¨ã„ã†ã®ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™. <code>None</code> ã®ã¨ãã¯ <strong>æŒ™å‹•ã¨ã—ã¦ã¯</strong> <code>.with(None)</code> ã‚’æ›¸ã‹ãªã‹ã£ãŸå ´åˆã¨åŒã˜ã«ãªã‚Šã¾ã™.
(è¿”ã™å‹ã¯ç•°ãªã‚Šã¾ã™.) ãƒ•ã‚¡ã‚¤ãƒ«å‡ºåŠ›ç”¨ã® layer ã¨ stdout å‡ºåŠ›ç”¨ã® layer ã‚’ãã‚Œãã‚Œ <code>Option</code> ã§åŒ…ã‚“ã§è¨­å®šã—ã¦ã„ã¾ã™.
ãã®ä¸­ã§ã¯å…ˆç¨‹ã® per-layer filtering ã‚’ä½¿ã£ã¦ã„ã¾ã™.</p>
<p>(ä¸¡æ–¹ <code>Some</code> ã®ã‚±ãƒ¼ã‚¹ãŒãªã„ã®ã§ã‚ã‚Œã°) ã“ã‚“ãªé¢å€’ãªã“ã¨ã‚’ã—ãªãã¦ã‚‚ã„ã„ã®ã§ã¯?ã¨æ€ã‚ã‚Œã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“.
<code>let logging = if ... else ... ;</code> ã§ layer ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹æ„Ÿã˜ã§ã™ã­. ã—ã‹ã—ã“ã‚Œã¯ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã§ãã¾ã›ã‚“.
(<code>EnvFilter</code> ã® <code>Layered</code> ã‚’ç„¡è¦–ã™ã‚‹ã¨) å®Ÿã¯ <code>tracing_subscriber::fmt::Layer</code> ã¯
<code>Layer&lt;Registry, N, E, W&gt;</code> ã§,
<a href="https://docs.rs/tracing-subscriber/0.3.22/tracing_subscriber/fmt/struct.Layer.html#method.with_writer"><code>.with_writer()</code></a>
ã¯å‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ <code>W</code> ã‚’å¤‰æ›´ã—ã¾ã™. stdout ã¨ãƒ•ã‚¡ã‚¤ãƒ«ã§ã“ã®éƒ¨åˆ†ãŒç•°ãªã‚‹ã®ã§åŒã˜å¤‰æ•°ã«ã¯å…¥ã‚Œã‚‰ã‚Œã¾ã›ã‚“.</p>
<p>å‹ã¨ã„ã†ã¨, (é–¢æ•°ã§ã¯ãªã) <code>fmt_layer!()</code> ã¨ã„ã†ãƒã‚¯ãƒ­ã‚’ä½¿ã£ã¦ã„ã‚‹ã®ã‚‚ãƒã‚¤ãƒ³ãƒˆã§ã™.</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#b48ead;">let</span><span> subscriber = Registry::default()
</span><span>    .</span><span style="color:#96b5b4;">with</span><span>(EnvFilter::from_default_env())
</span><span>    .</span><span style="color:#96b5b4;">with</span><span>(fmt::Layer::default());
</span><span>subscriber.</span><span style="color:#96b5b4;">init</span><span>();
</span></code></pre>
<p>ã® <code>subscriber</code> ã®å‹ã¯</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>layer::Layered&lt;fmt_layer::Layer&lt;???, N, E, W&gt;,
</span><span>               layer::Layered&lt;EnvFilter,
</span><span>                              Registry
</span><span>                              &gt;
</span><span>               &gt;
</span></code></pre>
<p>ã¨æ›¸ãã¾ã—ãŸãŒ, ã“ã® <code>???</code> ã¯ <code>layer::Layered&lt;EnvFilter, Registry&gt;</code> ã§ã™
[<a href="https://docs.rs/tracing-subscriber/0.3.22/tracing_subscriber/fmt/struct.Layer.html#method.with_subscriber"><code>fmt::Layer::with_subscriber()</code></a>]
[<a href="https://github.com/tokio-rs/tracing/blob/64e1c8d3ae5cf5deab40ad3d376c8595d4e4db7f/tracing-subscriber/src/layer/mod.rs#L1500-L1509"><code>SubscriberExt::with()</code></a>].
ã“ã“ã«ã¯ã€Œ<code>.with()</code> ã‚’ä»˜ã‘ã‚‹å‰ã® subscriber ã®å‹ã€ãŒå…¥ã‚Šã¾ã™. ã“ã‚“ãªã®æ‰‹æ›¸ãã—ãŸããªã„ã§ã™ã—,
<code>.with(stdout_logging...)</code> ã¨ <code>.with(file_logging...)</code> ã®ç®‡æ‰€ã§è¦æ±‚ã•ã‚Œã‚‹å‹ãŒç•°ãªã‚Šã¾ã™.
ãªã®ã§ãƒã‚¯ãƒ­ã«ã—ã¦ã„ã¾ã™.</p>
<h2 id="log-ni-span-context-wobiao-shi-sinai">log ã« span context ã‚’è¡¨ç¤ºã—ãªã„</h2>
<p>ä¸Šè¨˜ <code>fmt_layer!()</code> ã®éƒ¨åˆ†,</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span>tracing_subscriber::fmt::Layer::default()
</span><span>    .</span><span style="color:#96b5b4;">compact</span><span>()
</span><span>    .</span><span style="color:#96b5b4;">with_span_events</span><span>(tracing_subscriber::fmt::format::FmtSpan::</span><span style="color:#d08770;">NONE</span><span>)
</span><span>    .</span><span style="color:#96b5b4;">with_ansi</span><span>(</span><span style="color:#d08770;">true</span><span>)
</span><span>    .</span><span style="color:#96b5b4;">with_timer</span><span>(timer)
</span><span>    .</span><span style="color:#96b5b4;">with_level</span><span>(</span><span style="color:#d08770;">true</span><span>)
</span><span>    .</span><span style="color:#96b5b4;">with_target</span><span>(</span><span style="color:#d08770;">true</span><span>)
</span><span>    .</span><span style="color:#96b5b4;">with_file</span><span>(</span><span style="color:#d08770;">false</span><span>)
</span><span>    .</span><span style="color:#96b5b4;">with_line_number</span><span>(</span><span style="color:#d08770;">true</span><span>)
</span></code></pre>
<p>ã¨ã—ã¦ã„ã¾ã™ãŒ, å‡ºåŠ›ã¯ä¾‹ãˆã°</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>...
</span><span>23:39:47.066  INFO smithay::wayland::socket:72: Created new socket name=Some(&quot;wayland-2&quot;)
</span><span>23:39:47.068  INFO sabiniwm::state:234: Start listening on Wayland socket: WAYLAND_DISPLAY = wayland-2
</span><span>23:39:47.068  INFO input_seat:add_keyboard:input_keyboard: smithay::input::keyboard:672: Initializing a xkbcommon handler with keymap query name=&quot;winit&quot; xkb_config=XkbConfig { rules: &quot;&quot;, model: &quot;&quot;, layout: &quot;custom&quot;, variant: &quot;&quot;, options: None } repeat_delay=200 repeat_rate=60
</span><span>23:39:47.073  INFO input_seat:add_keyboard:input_keyboard: smithay::input::keyboard:680: Loaded Keymap name=&quot;Modifiers for MacBookAir&quot; name=&quot;winit&quot; xkb_config=XkbConfig { rules: &quot;&quot;, model: &quot;&quot;, layout: &quot;custom&quot;, variant: &quot;&quot;, options: None } repeat_delay=200 repeat_rate=60
</span><span>23:39:47.078  INFO smithay::xwayland::xserver:187: spawning XWayland instance
</span><span>...
</span></code></pre>
<p>ãªã©ã¨ãªã‚Šã¾ã™. 3è¡Œç›®ã¨4è¡Œç›®ã¯ãã‚Œä»¥å¤–ã¨ç•°ãªã‚Š <code>input_seat:add_keyboard:input_keyboard:</code> ã¨è¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã™ãŒ,
ã“ã‚Œã¯ log ã•ã‚ŒãŸã¨ãã®é“ä¸­ã® span ã‚’è¡¨ã—ã¦ã„ã¾ã™.</p>
<p>ã—ã‹ã—ã“ã‚Œ, çµæ§‹é‚ªé­”ã§ã™. span ã¯å¿…è¦ãªã¨ãã¯åˆ¥é€” perfetto ã§è¦‹ã‚‹ã¤ã‚‚ã‚Šã ã—, log ã¯ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã«
è¡¨ç¤ºã—ãŸã„. ã§ã¯ã©ã†ã‚„ã£ã¦æ¶ˆã™ã‹?</p>
<p>å®Ÿã¯ã“ã‚Œç°¡å˜ã«ã¯æ¶ˆã›ã¾ã›ã‚“. <code>tracing_subscriber::fmt::Layer</code> ã¯è‰²ã€…ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æŒã£ã¦ã„ã¾ã™ãŒ,
<a href="https://github.com/tokio-rs/tracing/blob/64e1c8d3ae5cf5deab40ad3d376c8595d4e4db7f/tracing-subscriber/src/fmt/format/mod.rs#L1094-L1104">FmtCtx</a>
ã«ã¯è¡¨ç¤ºã‚’å¼„ã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“. å›°ã‚Šã¾ã—ãŸã­... è‡ªä½œ formatter ã‚’ä½œã‚‹ã—ã‹ãªã„ã®ã§ã—ã‚‡ã†ã‹...?</p>
<p>ã„ã‚„, ã“ã®å ´åˆã¯ã§ãã¾ã™. ãã†, filter ãªã‚‰ã­!</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#65737e;">/// Filters out span context for event logging
</span><span style="color:#b48ead;">pub struct </span><span>NoSpanContextFilter;
</span><span>
</span><span style="color:#b48ead;">impl</span><span>&lt;S&gt; tracing_subscriber::layer::Filter&lt;S&gt; </span><span style="color:#b48ead;">for </span><span>NoSpanContextFilter
</span><span style="color:#b48ead;">where
</span><span>    S: tracing::Subscriber + </span><span style="color:#b48ead;">for</span><span>&lt;</span><span style="color:#b48ead;">&#39;a</span><span>&gt; tracing_subscriber::registry::LookupSpan&lt;</span><span style="color:#b48ead;">&#39;a</span><span>&gt;,
</span><span>{
</span><span>    </span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">enabled</span><span>(
</span><span>        &amp;</span><span style="color:#bf616a;">self</span><span>,
</span><span>        </span><span style="color:#bf616a;">metadata</span><span>: &amp;tracing_core::Metadata&lt;&#39;_&gt;,
</span><span>        </span><span style="color:#bf616a;">_cx</span><span>: &amp;tracing_subscriber::layer::Context&lt;&#39;_, S&gt;,
</span><span>    ) -&gt; </span><span style="color:#b48ead;">bool </span><span>{
</span><span>        !metadata.</span><span style="color:#96b5b4;">is_span</span><span>()
</span><span>    }
</span><span>}
</span><span>
</span><span>...
</span><span>
</span><span>    </span><span style="color:#b48ead;">let</span><span> subscriber = Registry::default()
</span><span>        .</span><span style="color:#96b5b4;">with</span><span>(
</span><span>            stdout_logging
</span><span>                .</span><span style="color:#96b5b4;">with_filter</span><span>(env_filter.</span><span style="color:#96b5b4;">clone</span><span>())
</span><span>                .</span><span style="color:#96b5b4;">with_filter</span><span>(NoSpanContextFilter),
</span><span>        )
</span><span>        .</span><span style="color:#96b5b4;">with</span><span>(
</span><span>            file_logging
</span><span>                .</span><span style="color:#96b5b4;">with_filter</span><span>(env_filter)
</span><span>                .</span><span style="color:#96b5b4;">with_filter</span><span>(NoSpanContextFilter),
</span><span>        );
</span><span>
</span><span>...
</span></code></pre>
<p><code>Filter::enabled()</code> ã§ span ã®ã¨ãã« false ã‚’è¿”ã—ã¦ã„ã¾ã™. ã“ã†ã™ã‚‹ã“ã¨ã§
<code>tracing_subscriber::fmt::Layer</code> ã«ä¸€åˆ‡ span ã‚’æ¸¡ã•ãš, span ç”±æ¥ã®è¡¨ç¤ºã‚’æ¶ˆã›ã¾ã™.</p>
<h2 id="perfetto-no-trace-file-wotu-ku">Perfetto ã® trace file ã‚’åã</h2>
<p>Perfetto ã¨ã„ã†ã®ã¯, span/log ã‚’å¯è¦–åŒ–ã—ã¦ãã‚Œã‚‹å›ã§ã™. è©³ã—ãã¯å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§.</p>
<p>ä½¿ã„å§‹ã‚ã‚‹ã®ã¯ç°¡å˜ã§ã™. layer ã‚’è¿½åŠ ã™ã‚‹ã ã‘ã§ã™ã­.</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span>...
</span><span>    </span><span style="color:#b48ead;">use </span><span>tracing_perfetto::PerfettoLayer;
</span><span>
</span><span>    </span><span style="color:#b48ead;">let</span><span> perfetto_tracing = </span><span style="color:#b48ead;">match </span><span>std::env::var(&quot;</span><span style="color:#a3be8c;">HOGE_PFTRACE_PATH</span><span>&quot;) {
</span><span>        Err(std::env::VarError::NotPresent) | Err(std::env::VarError::NotUnicode(_)) =&gt; None,
</span><span>        Ok(path) =&gt; {
</span><span>            </span><span style="color:#b48ead;">let</span><span> file = std::fs::File::create(path)?;
</span><span>            Some(PerfettoLayer::new(std::sync::Mutex::new(file)))
</span><span>        }
</span><span>    };
</span><span>
</span><span>...
</span><span>
</span><span>    </span><span style="color:#b48ead;">let</span><span> subscriber = Registry::default()
</span><span>        .</span><span style="color:#96b5b4;">with</span><span>(perfetto_tracing)
</span><span>        .</span><span style="color:#96b5b4;">with</span><span>(
</span><span>            stdout_logging
</span><span>                .</span><span style="color:#96b5b4;">with_filter</span><span>(env_filter.</span><span style="color:#96b5b4;">clone</span><span>())
</span><span>                .</span><span style="color:#96b5b4;">with_filter</span><span>(NoSpanContextFilter),
</span><span>        )
</span><span>        .</span><span style="color:#96b5b4;">with</span><span>(
</span><span>            file_logging
</span><span>                .</span><span style="color:#96b5b4;">with_filter</span><span>(env_filter)
</span><span>                .</span><span style="color:#96b5b4;">with_filter</span><span>(NoSpanContextFilter),
</span><span>        );
</span><span>
</span><span>...
</span></code></pre>
<p>ç°¡å˜ã¨ã¯è¨€ã„ã¾ã—ãŸãŒ, è‡ªåˆ†ã¯ãƒãƒã‚Šã¾ã—ãŸ. å‰è¿°ã®</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#b48ead;">let</span><span> subscriber = Registry::default()
</span><span>    .</span><span style="color:#96b5b4;">with</span><span>(ã“ã“ã§ log and/or span ã‚’è¨˜éŒ²ã™ã‚‹ä½•ã‹)
</span><span>    .</span><span style="color:#96b5b4;">with</span><span>(EnvFilter::from_default_env())
</span><span>    .</span><span style="color:#96b5b4;">with</span><span>(fmt::Layer::default());
</span><span>subscriber.</span><span style="color:#96b5b4;">init</span><span>();
</span></code></pre>
<p>ã«å¼•ã£æ›ã‹ã£ã¦ <code>EnvFilter</code> ã§ filtering ã•ã‚Œã¦ã—ã¾ã£ãŸã®ã§ã™. ä¸Šã§å˜ã«è¿½åŠ ã™ã‚‹ã ã‘ã§æ¸ˆã‚“ã ã®ã¯,
æ—¢ã« per-filter filtering ã‚’ä½¿ã£ã¦ã„ãŸã‹ã‚‰ã§ã™.</p>
<p><strong><code>tracing_subscriber::fmt().&lt;...&gt;.init()</code> ã§æ¸ˆã¾ãªã„ã¨ãã¯ per-layer filtering ã‚’ä½¿ã†.</strong>
ã§ãªã„ã¨ã“ã†ã„ã†ç½ ã«ãƒãƒã‚‹ã“ã¨ã«ãªã‚Šã¾ã™. ã“ã‚Œã ã‘ã¯ã¯ã£ãã‚Šã¨çœŸå®Ÿã‚’ä¼ãˆãŸã‹ã£ãŸ <sup class="footnote-reference"><a href="#7">7</a></sup>.</p>
<h2 id="rust-deno-perfetto-nituite">Rust ã§ã® perfetto ã«ã¤ã„ã¦</h2>
<p>Perfetto ã¯ Rust ã® tracing ã¨ã‚ã‚“ã¾ã‚Šç›¸æ€§ãŒè‰¯ããªã„ <sup class="footnote-reference"><a href="#8">8</a></sup>.</p>
<p>Perfetto ã«ã¯ category ã¨ã‹ track ã¨ã‹ flow ã¨ã‹ã®ç‹¬è‡ªæ¦‚å¿µãŒã‚ã‚‹
[<a href="https://perfetto.dev/docs/instrumentation/track-events">doc</a>].
category ã¯ã¾ããªãã¦ã‚‚ env filter ã¨ã‹ã§ä»£ç”¨ã§ãã‚‹.
ã—ã‹ã— track/flow ã¯ä»£æ›¿æ‰‹æ®µãŒãªã„ã—, æ˜¯éä½¿ã„ãŸã„.</p>
<p>ã§ã¯ Rust ã§ã®ã‚µãƒãƒ¼ãƒˆçŠ¶æ³ã¯ã¨ã„ã†ã¨...</p>
<ul>
<li><a href="https://github.com/google/perfetto">perfetto-sdk</a>
<ul>
<li>Google å…¬å¼.</li>
<li>C++ ã¨åŒæ§˜ã®ãƒã‚¯ãƒ­ã§è¨˜éŒ².</li>
<li><a href="https://github.com/google/perfetto/blob/v53.0/contrib/rust-sdk/perfetto/src/track_event.rs#L1441-L1452">flow ã‚µãƒãƒ¼ãƒˆãªã—.</a>
Google æ°ã€œã€œã€œ ãŒã‚“ã°ã£ã¦ãã‚Œã€œã€œã€œ</li>
</ul>
</li>
<li><a href="https://github.com/csmoe/tracing-perfetto">tracing-perfetto</a>
<ul>
<li>flow ã‚µãƒãƒ¼ãƒˆã¯ã§ããªã„/ã—ã¦ãªã„ã¯ãš <sup class="footnote-reference"><a href="#9">9</a></sup>.</li>
</ul>
</li>
<li><a href="https://github.com/modal-labs/tracing-perfetto-sdk">tracing-perfetto-sdk-layer</a>
<ul>
<li>flow ã‚µãƒãƒ¼ãƒˆã¯ã§ããªã„/ã—ã¦ãªã„ã¯ãš.</li>
</ul>
</li>
<li><a href="https://github.com/davidlattimore/perfetto-recorder">perfetto-recorder</a>
<ul>
<li><code>tracing</code> ã§ã¯ãªã„, ç‹¬è‡ªãƒã‚¯ãƒ­ã§è¨˜éŒ².</li>
<li><a href="https://github.com/davidlattimore/perfetto-recorder?tab=readme-ov-file#performance">tracing ç³»ã®ã‚„ã¤ã‚‰ãŒé…ã„ã‹ã‚‰</a> ã‚‰ã—ã„.</li>
<li><a href="https://github.com/davidlattimore/perfetto-recorder?tab=readme-ov-file#unsupported-features">flow ã‚µãƒãƒ¼ãƒˆãªã—.</a></li>
</ul>
</li>
</ul>
<p>ãã†! èª°ã‚‚ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ãªã„ã®ã§ã‚ã‚‹! <sup class="footnote-reference"><a href="#10">10</a></sup></p>
<p>ã†ã€œã‚“, å›°ã‚Šã¾ã—ãŸ. å›°ã£ãŸã®ã§ä»Šå¹´ã¯ã‚‚ã†å¯ã¾ã™.</p>
<h2 id="perfetto-deno-trace-qu-de-wodong-de-niqie-riti-eru">Perfetto ã§ã® trace å–å¾—ã‚’å‹•çš„ã«åˆ‡ã‚Šæ›¿ãˆã‚‹</h2>
<p>ã•ã¦, Chromium/Chrome ã§ã¯ chrome://traring ã‚’é–‹ã„ã¦èµ·å‹•å¾Œã«å‹•çš„ã« recording ã‚’é–‹å§‹/åœæ­¢ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™
[<a href="https://chromium.googlesource.com/chromium/src/+/HEAD/services/tracing/perfetto/README.md">doc</a>].
å½“ç„¶ã“ã®æ©Ÿèƒ½ã‚‚æ¬²ã—ã„ã§ã™ã‚ˆã­.</p>
<p>on/off ãªã©ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã¯ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æ¯ã«å¤§ããå¤‰ã‚ã‚‹ã§ã—ã‚‡ã†ã‹ã‚‰, sabiniwm ã§ã®ä¾‹ã‚’è¦‹ã¾ã—ã‚‡ã†
[<a href="https://github.com/kenoss/sabiniwm/blob/37b905f1be292355dd12194a50f6ab64a1975cae/crates/sabiniwm_pistachio/src/main.rs#L32">cs</a>].</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">tracing_init</span><span>() -&gt; eyre::Result&lt;Option&lt;ToggleFilterHandle&lt;Registry&gt;&gt;&gt; {
</span><span>
</span><span>...
</span><span>
</span><span>    </span><span style="color:#b48ead;">use </span><span>sabiniwm_tracing_helper::debug::ToggleFilter;
</span><span>
</span><span>    </span><span style="color:#b48ead;">let </span><span>(perfetto_toggle_filter, perfetto_toggle_handle) = ToggleFilter::new(</span><span style="color:#d08770;">false</span><span>);
</span><span>
</span><span>...
</span><span>
</span><span>    </span><span style="color:#b48ead;">let</span><span> subscriber = Registry::default()
</span><span>        .</span><span style="color:#96b5b4;">with</span><span>(perfetto_tracing.</span><span style="color:#96b5b4;">with_filter</span><span>(perfetto_toggle_filter))
</span><span>        .</span><span style="color:#96b5b4;">with</span><span>(
</span><span>            stdout_logging
</span><span>                .</span><span style="color:#96b5b4;">with_filter</span><span>(env_filter.</span><span style="color:#96b5b4;">clone</span><span>())
</span><span>                .</span><span style="color:#96b5b4;">with_filter</span><span>(NoSpanContextFilter),
</span><span>        )
</span><span>        .</span><span style="color:#96b5b4;">with</span><span>(
</span><span>            file_logging
</span><span>                .</span><span style="color:#96b5b4;">with_filter</span><span>(env_filter)
</span><span>                .</span><span style="color:#96b5b4;">with_filter</span><span>(NoSpanContextFilter),
</span><span>        );
</span><span>    subscriber.</span><span style="color:#96b5b4;">init</span><span>();
</span><span>
</span><span>    Ok(Some(perfetto_toggle_handle))
</span><span>}
</span></code></pre>
<p>ã‚‚ã†è©³ã—ã„èª¬æ˜ã¯è¦ã‚‰ãªã„ã§ã—ã‚‡ã†. on/off å¯èƒ½ãª filter <code>ToggleFilter</code> ã¨ãã® handle ã®ãƒšã‚¢ã‚’ä½œã‚Š,
å¿…è¦ãªã¨ãã ã‘ on ã«ã—ã¦ event ã‚’æµã™ã‚ˆã†ã«ã—ã¦ã„ã¾ã™. sabiniwm ã§ã¯ã“ã® handle ã‚’ <code>Action</code> ã«ã—ã¦
ã‚­ãƒ¼ãƒã‚¤ãƒ³ãƒ‰ã‹ã‚‰å®Ÿè¡Œå¯èƒ½ã«ã—ã¦ã„ã¾ã™.</p>
<h2 id="matome">ã¾ã¨ã‚</h2>
<ul>
<li><code>tracing_subscriber</code> ã§ã¯ <code>Registry</code>, <code>Subscriber</code>, <code>Layer</code>, <code>Filter</code> ãŒè‚è¦.</li>
<li><strong><code>tracing_subscriber::fmt().&lt;...&gt;.init()</code> ã§æ¸ˆã¾ãªã„ã¨ãã¯ per-layer filtering ã‚’ä½¿ã†.</strong></li>
<li>ã‚ã¨ã¯ <code>Layer</code> ã¨ã‹ <code>Filter</code> ã‚’è¦‹ã¦ã„ã‘ã°è‰²ã€…ã‚„ã‚ŠãŸã„æ‹¡å¼µã‚’å®Ÿç¾ã§ãã‚‹.</li>
</ul>
<p>å¹´æœ«ã§ã™ã—çš†ã•ã‚“ã‚‚ã”è‡ªèº«ã® tracing è¨­å®šã‚’ç¢ºèªã•ã‚Œã¦ã¿ã¦ã¯ã„ã‹ãŒã§ã—ã‚‡ã†ã‹?</p>
<p>Happy holidays!</p>
<div class="footnote-definition" id="1"><sup class="footnote-definition-label">1</sup>
<p>ãªãŠ Seriese 2 ã®æ–¹ã® 13 æ—¥ç›®ã®è¨˜äº‹ã¯
<a href="https://zenn.dev/oyatomo/articles/9cebd37807cd4c">Ray Tracing from Scratch in Rust ~ ç°¡æ˜“CPUãƒ¬ãƒ³ãƒ€ãƒ©ã®è‡ªä½œã¨ä»•çµ„ã¿ã®å‹‰å¼· ~</a>
ã§ã™. tracing é•ã„ã§ã™ã­.</p>
</div>
<div class="footnote-definition" id="2"><sup class="footnote-definition-label">2</sup>
<p>å®Ÿéš›, <code>tracing_subscriber</code> ã§ã¯ <code>Registry</code>, <code>Subscriber</code>, <code>Layer</code>, <code>Filter</code> ãŒè‚è¦ã§ã™ã—
å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚‚ã“ã®ã‚ãŸã‚Šã®æ¦‚å¿µã«æ²¿ã£ã¦æ›¸ã‹ã‚Œã¦ã„ã¾ã™ãŒ, <code>tracing_subscriber::fmt()</code>
ã¯ã“ã‚Œã‚‰å…¨ã¦ã‚’è¦†ã„éš ã—ã¦ã„ã‚‹ãŸã‚ã€Œã†ãƒ¼ã‚“ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«æ›¸ã„ã¦ã‚ã‚‹ã“ã‚Œã¯ã©ã“?ã€ã¨ãªã‚Šã¾ã™.
ãªã£ãŸ.</p>
</div>
<div class="footnote-definition" id="3"><sup class="footnote-definition-label">3</sup>
<p>ã“ã‚Œã¯å˜˜.</p>
</div>
<div class="footnote-definition" id="4"><sup class="footnote-definition-label">4</sup>
<p>ã€Œã˜ã‚ƒã‚ã€Layerã€ã£ã¦ä½•ã ã‚ˆ! ãªã‚“ã§ Layer ã£ã¦åå‰ãªã‚“ã ã‚ˆ!ã€ã¨æ€ã„ã¾ã™ãŒ, æ­´å²ã®è©±ã‚’è¿½ã†ã®ã¯
ã‚ã‚“ã©ãã•ãã†ãªã®ã§ã‚„ã‚ã¦ãŠãã¾ã™. èª¿ã¹ã¦ã‚‹æ™‚é–“ãªã„ã—. è©³ã—ã„æ–¹ãŒã„ãŸã‚‰æ•™ãˆã¦ãã ã•ã„.
(ã¾ãçŸ­çµ¡è©•ä¾¡ã—ãŸã‚Šã™ã‚‹ã¨ã“ã‚ã¨ã‹ã¯ Layer ã£ã¦æ„Ÿã˜ã¯ã™ã‚‹ã—, ãã‚Œè¨€ã£ãŸã‚‰
<code>tracing_subscriber::fmt::Layer</code> ã¯ Layer ã¨ã„ã†åå‰ãŒé©åˆ‡ãªã‚“ã‹?ã¨ã„ã†è©±ã«ã¯, ãªã‚‹.)</p>
</div>
<div class="footnote-definition" id="5"><sup class="footnote-definition-label">5</sup>
<p><a href="https://docs.rs/tracing-subscriber/0.3.22/tracing_subscriber/layer/index.html#global-filtering">https://docs.rs/tracing-subscriber/0.3.22/tracing_subscriber/layer/index.html#global-filtering</a></p>
</div>
<div class="footnote-definition" id="6"><sup class="footnote-definition-label">6</sup>
<p>å…·ä½“çš„ã«ã¯, sabiniwm ã§ã¯ udev backend (TTY ã‹ã‚‰èµ·å‹•) ã®ã¨ãã¯ file ã«æ›¸ã,
winit backend ã®ã¨ãã¯ stdout ã«å‡ºã—ã¦ã„ã¾ã™.</p>
</div>
<div class="footnote-definition" id="7"><sup class="footnote-definition-label">7</sup>
<p>å®Ÿéš›, ã“ã‚ŒãŒã“ã®è¨˜äº‹ã‚’æ›¸ã“ã†ã¨æ€ã£ãŸæ±ºã‚æ‰‹ã§ã™.</p>
</div>
<div class="footnote-definition" id="8"><sup class="footnote-definition-label">8</sup>
<p>æ¦‚å¿µçš„ã«ã‚‚ã¯ã¾ã‚‰ãªã„ã—, ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹çš„ã«ã‚‚ç„¡ç†ãªæ°—ãŒã™ã‚‹?
ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ <code>tracing</code> ä½¿ã£ã¦ã‚‹ã®è‡ªä½“ã¯å¤‰æ›´ã§ããªã„ã®ã§, <code>tracing</code> ã‚’åŸºæœ¬ã«ã—ã¤ã¤ã‚¢ãƒ—ãƒªå´ã§
å¿…è¦ãªã¨ã“ã‚ã¯ <code>trace_event/trace_event_begin/trace_event_end</code> ã‚’ä½¿ã†ã¨ã‹ãŒç†æƒ³ã§ã¯ã‚ã‚Šã¾ã™.</p>
</div>
<div class="footnote-definition" id="9"><sup class="footnote-definition-label">9</sup>
<p>ä¸€å¿œ src/perfetto.protos.rs ã¾ã§ã¯æ¥ã¦ã„ã‚‹ãŒ, ã“ã‚Œã¯è‡ªå‹•ç”Ÿæˆã£ã¦ã ã‘ã ã‚ã†ã—.</p>
</div>
<div class="footnote-definition" id="10"><sup class="footnote-definition-label">10</sup>
<p>èª°ã‹ã‚µãƒãƒ¼ãƒˆæ¸ˆã¿ã ã£ãŸã‚‰, ã‚¹ãƒãƒ³.</p>
</div>

    </div>
</article>

            </main>
            <footer>
                <div class="footer">
                    <small class="footer-left">
                        Â© 2021--2024. All rights reserved.
                    </small>
                    <small class="footer-right">
                        Powered by <a href="https://www.getzola.org">Zola</a>
                    </small>
                </div>
            </footer>
        </div>
    </body>
</html>
